services:
  # 只部署后端容器，复用现有 Nginx
  dreambook-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dreambook-backend
    ports:
      - "127.0.0.1:3001:3000"  # 只监听本地，通过 Nginx 代理
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - TZ=Asia/Shanghai
    # 加入现有网络（如果 emotion-library 有自定义网络）
    # networks:
    #   - emotion-library-network
    restart: always
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# 如果需要加入现有网络，取消下面注释
# networks:
#   emotion-library-network:
#     external: true
