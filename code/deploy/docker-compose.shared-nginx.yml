services:
  # 只部署后端容器，复用现有 Nginx
  dreambook-backend:
    build:
      context: ../dreambook-api    # 指向新的 API 目录
      dockerfile: Dockerfile
    container_name: dreambook-backend
    ports:
      - "127.0.0.1:3001:3000"  # 只监听本地，通过 Nginx 代理
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - TZ=Asia/Shanghai
    # 如果需要加入现有网络（emotion-library），取消下面注释
    # networks:
    #   - emotion-library_default
    restart: always
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# 前端不需要容器！
# 前端构建后，直接复制到现有 Nginx 容器：
# docker cp ../dreambook-web/dist emotion-library-nginx-prod:/usr/share/nginx/html/dreambook

# 如果需要加入现有网络，取消下面注释
# networks:
#   emotion-library_default:
#     external: true
