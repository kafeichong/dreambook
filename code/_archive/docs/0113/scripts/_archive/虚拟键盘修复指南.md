# Kiosk 虚拟键盘修复指南

## 问题说明

在 Admin 账户下虚拟键盘可以正常显示，但在 kiosk 用户下无法显示虚拟键盘。

这是因为：
1. **权限问题** - kiosk 用户没有足够的权限访问 TabTip.exe
2. **服务配置** - TabletInputService 可能没有为 kiosk 用户正确配置
3. **注册表设置** - kiosk 用户的注册表中缺少虚拟键盘配置

---

## 🚀 快速修复（推荐）

### 方法 1：一键修复（最简单）

```
1. 双击 run-fix-keyboard-as-admin.bat
2. 点击"是"（UAC 提示）
3. 等待修复完成
4. 如果 kiosk 用户当前已登录，需要注销重新登录
5. 测试虚拟键盘功能
```

### 方法 2：使用批处理版本

```
1. 右键 fix-keyboard-kiosk.bat
2. 选择"以管理员身份运行"
3. 等待修复完成
4. 注销并重新登录 kiosk 用户（如果已登录）
5. 测试虚拟键盘功能
```

### 方法 3：使用 PowerShell 版本

```
1. 使用 run-fix-keyboard-as-admin.bat（自动）
2. 或手动以管理员身份打开 PowerShell
3. 运行: .\fix-keyboard-kiosk.ps1
```

---

## 🔍 诊断工具

如果修复后仍有问题，使用诊断工具：

```
双击 diagnose-keyboard.bat
```

诊断工具会检查：
- 当前用户身份
- TabletInputService 服务状态
- TabTip.exe 文件是否存在及权限
- Kiosk 用户是否存在
- 注册表配置
- 用户权限级别

诊断报告会保存到 `keyboard-diagnostic.txt`

---

## 📋 修复脚本做了什么

### 1. 检查并启动 TabletInputService
- 设置为自动启动
- 启动服务

### 2. 设置 TabTip.exe 权限
- 给 kiosk 用户授予读取和执行权限
- 涵盖 64 位和 32 位版本

### 3. 配置系统注册表
- 创建必要的注册表项
- 启用虚拟键盘功能

### 4. 配置 kiosk 用户配置文件
- 加载用户注册表（如果用户未登录）
- 启用触摸键盘自动调用
- 设置键盘停靠状态

### 5. 设置目录权限
- 给 kiosk 用户授予 ink 目录的读取权限

### 6. 验证用户组成员身份
- 确保 kiosk 用户在 Users 组中

---

## ⚠️ 重要注意事项

### 1. **必须以管理员身份运行修复脚本**
- 使用 `run-fix-keyboard-as-admin.bat` 可以自动请求管理员权限

### 2. **用户登录状态**
- 如果 kiosk 用户当前已登录，某些配置无法应用
- **解决方案：** 注销 kiosk 用户，以管理员身份运行修复脚本，然后重新登录

### 3. **修复后必须重新登录**
- 配置更改需要重新登录才能生效
- 步骤：注销 kiosk 用户 → 重新登录 → 测试虚拟键盘

### 4. **Windows 版本差异**
- Windows 10：通常使用 TabTip.exe
- Windows 11：可能使用不同的虚拟键盘系统
- 脚本兼容两者

---

## 🔧 手动修复步骤

如果脚本无法运行，可以手动执行：

### 1. 启动 TabletInputService
```cmd
sc config TabletInputService start= auto
sc start TabletInputService
```

### 2. 设置 TabTip.exe 权限
```cmd
icacls "C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe" /grant kiosk:RX /T
```

### 3. 配置注册表
```cmd
reg add "HKLM\SOFTWARE\Microsoft\TabletTip\1.7" /f
```

### 4. 配置用户注册表（需要用户未登录）
```cmd
reg load HKU\kiosk_temp "C:\Users\kiosk\NTUSER.DAT"
reg add "HKU\kiosk_temp\Software\Microsoft\TabletTip\1.7" /v EnableDesktopModeAutoInvoke /t REG_DWORD /d 1 /f
reg unload HKU\kiosk_temp
```

### 5. 设置目录权限
```cmd
icacls "C:\Program Files\Common Files\microsoft shared\ink" /grant "kiosk:(OI)(CI)RX" /T
```

---

## 📝 故障排除

### 问题 1：修复脚本运行后仍无法显示键盘

**可能原因：**
- kiosk 用户在修复时处于登录状态
- 修复后没有重新登录

**解决方案：**
1. 注销 kiosk 用户
2. 以管理员身份重新运行修复脚本
3. 重新登录 kiosk 用户
4. 测试键盘功能

### 问题 2：提示"权限不足"

**解决方案：**
- 使用 `run-fix-keyboard-as-admin.bat`
- 或右键脚本选择"以管理员身份运行"
- 在 UAC 提示时点击"是"

### 问题 3：TabletInputService 无法启动

**可能原因：**
- 服务被禁用
- 系统缺少必要组件

**解决方案：**
```cmd
# 重置服务
sc config TabletInputService start= demand
sc config TabletInputService start= auto
sc start TabletInputService
```

### 问题 4：仍然无法显示键盘

**进一步排查：**
1. 运行 `diagnose-keyboard.bat` 获取诊断报告
2. 检查 Windows 更新（可能需要更新触摸键盘组件）
3. 检查组策略设置：
   ```
   运行 gpedit.msc
   导航到：计算机配置 → 管理模板 → Windows 组件 → 触摸键盘和手写面板
   确保没有禁用策略
   ```
4. 检查设备是否被系统识别为触摸设备：
   ```cmd
   Get-PnpDevice | Where-Object {$_.FriendlyName -like "*touch*"}
   ```

---

## ✅ 验证修复是否成功

### 1. 检查服务状态
```cmd
sc query TabletInputService
```
应显示 `STATE: 4 RUNNING`

### 2. 检查文件权限
```cmd
icacls "C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"
```
应显示 `kiosk:(RX)` 权限

### 3. 测试虚拟键盘
- 登录 kiosk 用户
- 打开 DreamBook 应用
- 点击输入框
- 虚拟键盘应自动弹出

### 4. 手动测试 TabTip.exe
在 kiosk 用户下运行：
```cmd
"C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"
```
键盘应该弹出

---

## 📊 修复成功率提升建议

### 执行顺序（推荐）：

1. **在 Admin 账户下：**
   - 运行 `run-fix-keyboard-as-admin.bat`
   - 确保 kiosk 用户未登录

2. **切换到 kiosk 用户：**
   - 重新登录
   - 测试虚拟键盘

3. **如果仍有问题：**
   - 返回 Admin 账户
   - 运行 `diagnose-keyboard.bat`
   - 查看诊断报告
   - 根据报告进行针对性修复

---

## 🆘 需要帮助？

如果以上方法都无法解决问题：

1. 查看日志文件：`fix-keyboard-kiosk.log`
2. 查看诊断报告：`keyboard-diagnostic.txt`
3. 确认 Windows 版本和更新状态
4. 检查是否有组策略限制
5. 考虑使用传统屏幕键盘（osk.exe）作为备选方案

---

## 📚 相关文件

| 文件 | 用途 |
|------|------|
| **run-fix-keyboard-as-admin.bat** | 一键修复（推荐） |
| **fix-keyboard-kiosk.bat** | 批处理修复脚本 |
| **fix-keyboard-kiosk.ps1** | PowerShell 修复脚本 |
| **diagnose-keyboard.bat** | 诊断工具 |
| **fix-keyboard-kiosk.log** | 修复日志 |
| **keyboard-diagnostic.txt** | 诊断报告 |

---

最后更新：2026-01-13
