# 虚拟键盘修复 - 紧急指南

## 🚨 你遇到的问题

运行修复脚本时出现 **"拒绝访问"** 错误，虽然显示"SUCCESS"但实际上权限设置失败了。

### 错误原因：
1. TabTip.exe 文件被 **TrustedInstaller** 保护
2. 需要先 **获取文件所有权**，然后才能修改权限
3. 之前的脚本没有执行 takeown（获取所有权）步骤

---

## ✅ 解决方案（v2.0 增强版）

我已经创建了 **v2.0 增强版**修复脚本，它会：
1. ✅ 先使用 `takeown` 获取文件所有权
2. ✅ 再使用 `icacls` 设置权限
3. ✅ 创建手动启动键盘的快捷方式
4. ✅ 配置所有必要的注册表项

---

## 🚀 立即执行（最新步骤）

### 方法 1：使用 v2.0 PowerShell 版本（推荐）

```
1. 确保 kiosk 用户已注销（重要！）
2. 双击：run-fix-keyboard-as-admin.bat（已更新指向 v2.0）
3. 点击"是"（UAC 提示）
4. 等待完成
5. 重新登录 kiosk 用户
6. 测试虚拟键盘
```

### 方法 2：直接运行批处理版本

```
1. 右键：fix-keyboard-kiosk-v2.bat
2. 选择"以管理员身份运行"
3. 等待完成
```

### 方法 3：手动运行 PowerShell 版本

```
1. 以管理员身份打开 PowerShell
2. cd 到脚本目录
3. .\fix-keyboard-kiosk-v2.ps1
```

---

## ⚠️ 关键注意事项

### 1. **必须先注销 kiosk 用户！**

如果 kiosk 用户当前已登录：
```
a) 切换到管理员账户
b) 注销 kiosk 用户（不是切换用户！）
c) 以管理员身份运行 v2.0 修复脚本
d) 重新登录 kiosk 用户
```

**为什么？** 因为用户登录时，用户的注册表文件（NTUSER.DAT）被锁定，无法修改。

### 2. **确认脚本真的以管理员身份运行**

检查 PowerShell 窗口标题栏是否有 **"管理员"** 字样。

### 3. **查看详细日志**

v2.0 会生成：`fix-keyboard-kiosk-v2.log`

---

## 🧪 验证修复是否成功

### 测试 1：检查文件权限
```cmd
# 在管理员命令提示符中运行
icacls "C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"

# 应该看到：
# kiosk:(RX)
```

### 测试 2：手动启动键盘
```cmd
# 在 kiosk 用户下运行
C:\kiosk\launch-keyboard.bat

# 或直接运行
"C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"

# 键盘应该弹出
```

### 测试 3：在 DreamBook 中测试
```
1. 登录 kiosk 用户
2. 启动 DreamBook 应用
3. 点击输入框
4. 虚拟键盘应该自动弹出
```

---

## 🔍 如果 v2.0 仍然失败

### 检查步骤：

1. **确认以管理员身份运行**
   ```cmd
   whoami /groups | find "S-1-16-12288"
   ```
   如果找到 S-1-16-12288，说明是管理员

2. **检查 UAC 设置**
   - 打开控制面板 → 用户账户 → 更改用户账户控制设置
   - 确保不是最高级别（否则 takeown 可能失败）

3. **检查组策略**
   ```
   运行：gpedit.msc
   导航到：计算机配置 → 管理模板 → Windows 组件 → 触摸键盘和手写面板
   确保所有策略都是"未配置"
   ```

4. **使用诊断工具**
   ```
   运行：diagnose-keyboard.bat
   查看生成的报告
   ```

---

## 🆘 终极备选方案

如果所有方法都失败，使用传统屏幕键盘作为临时方案：

### 在 electron/main.ts 中修改虚拟键盘函数：

```typescript
function showWindowsVirtualKeyboard(): void {
  // 使用传统屏幕键盘 (osk.exe) - 不需要特殊权限
  exec('osk.exe', (error) => {
    if (error) {
      log(`[虚拟键盘] OSK 启动失败: ${error.message}`)
    } else {
      log('[虚拟键盘] ✅ 传统屏幕键盘已启动')
    }
  })
}
```

osk.exe 的优点：
- ✅ 不需要特殊权限
- ✅ 所有用户都可以访问
- ✅ 系统自带，无需配置

osk.exe 的缺点：
- ❌ 界面较旧
- ❌ 不支持现代触摸手势
- ❌ 不会自动弹出

---

## 📋 完整执行清单

- [ ] 1. 切换到管理员账户
- [ ] 2. 注销 kiosk 用户（如果已登录）
- [ ] 3. 双击 `run-fix-keyboard-as-admin.bat`
- [ ] 4. 点击"是"（UAC）
- [ ] 5. 等待 v2.0 脚本完成
- [ ] 6. 检查是否有"拒绝访问"错误
- [ ] 7. 查看 `fix-keyboard-kiosk-v2.log`
- [ ] 8. 重新登录 kiosk 用户
- [ ] 9. 测试 `C:\kiosk\launch-keyboard.bat`
- [ ] 10. 测试 DreamBook 应用中的虚拟键盘

---

## 📞 下一步

1. **立即执行 v2.0 修复脚本**
   - 使用：`run-fix-keyboard-as-admin.bat`（已更新）

2. **如果成功**
   - 测试虚拟键盘
   - 完成！

3. **如果仍失败**
   - 发送 `fix-keyboard-kiosk-v2.log` 内容
   - 考虑使用 osk.exe 备选方案

---

最后更新：2026-01-13 - v2.0 增强版
