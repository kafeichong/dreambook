# DreamBook Kiosk 部署指南

> 从开发到生产环境的完整部署流程

---

## 📋 部署前检查清单

### 代码准备

- [ ] 所有代码修改已完成
- [ ] TypeScript 编译无错误
- [ ] 没有 console.error 或 console.warn
- [ ] 所有 TODO 注释已处理
- [ ] 代码已提交到 Git

### 功能验证

- [ ] 虚拟键盘功能正常
- [ ] 管理面板可以打开
- [ ] 切换用户功能可以调用
- [ ] 没有内存泄漏
- [ ] 没有性能问题

### 系统准备

- [ ] Windows 10 系统已准备
- [ ] 管理员账户可用
- [ ] 网络连接正常
- [ ] 磁盘空间充足（至少 2GB）

---

## 🚀 部署流程

### 阶段 1：本地编译和打包

#### 步骤 1.1：安装依赖

```bash
cd /Users/steven/works/20251130dreambook/code/dreambook

# 清理旧的 node_modules（可选）
rm -rf node_modules
rm -rf .yarn/cache

# 安装依赖
yarn install
```

**验证：**
```bash
# 检查依赖是否安装成功
yarn list | head -20
```

---

#### 步骤 1.2：编译 TypeScript

```bash
# 检查 TypeScript 类型
yarn build:skip-check

# 或完整编译（包括类型检查）
yarn build
```

**预期输出：**
```
✓ 编译成功
✓ 没有类型错误
✓ 生成 dist 目录
```

**故障排查：**
```bash
# 如果编译失败，查看详细错误
yarn build 2>&1 | tee build.log

# 检查特定文件
npx tsc --noEmit src/components/AdminPanel/AdminPanel.tsx
```

---

#### 步骤 1.3：打包 Electron 应用

##### 3.1 macOS 打包

```bash
# 打包为 macOS 应用
yarn electron:build:mac

# 创建 DMG 安装包（通用版本）
yarn electron:dmg
```

**输出文件：**
```
dist/DreamBook-x.x.x.dmg          # macOS 安装包
dist/DreamBook-x.x.x-arm64.dmg    # Apple Silicon 版本
dist/DreamBook-x.x.x-x64.dmg      # Intel 版本
```

---

##### 3.2 Windows 打包

```bash
# 打包为 Windows 应用
yarn electron:build:win
```

**输出文件：**
```
dist/DreamBook Setup x.x.x.exe    # Windows 安装程序
dist/DreamBook x.x.x.exe          # 便携版本
```

**注意：** 需要在 Windows 环境下执行，或使用 CI/CD 工具

---

#### 步骤 1.4：验证打包结果

```bash
# 检查输出文件
ls -lh dist/

# 验证文件大小（应该在 100-300MB 之间）
du -sh dist/DreamBook*

# 验证文件完整性
file dist/DreamBook*
```

---

### 阶段 2：Windows 系统配置

#### 步骤 2.1：准备 Windows 10 设备

**硬件要求：**
- CPU：Intel Core i5 或更高
- RAM：4GB 或更高
- 存储：10GB 可用空间
- 显示器：触摸屏（推荐）

**系统要求：**
- Windows 10 19042 或更高
- 管理员账户可用
- 网络连接正常

---

#### 步骤 2.2：运行配置脚本

```cmd
# 1. 以管理员身份打开 PowerShell
# 右键点击 PowerShell → 以管理员身份运行

# 2. 导航到脚本目录
cd "C:\path\to\setup-scripts"

# 3. 运行配置脚本
.\setup-kiosk.bat

# 4. 按照提示完成配置
```

**预期输出：**
```
✅ kiosk 用户创建成功
✅ 自动登录配置成功
✅ Shell 替换配置成功
✅ 虚拟键盘服务启用成功
✅ 配置完成！
```

---

#### 步骤 2.3：验证系统配置

```cmd
# 运行验证脚本
.\verify-kiosk.bat

# 预期输出：
# ✅ kiosk 用户存在
# ✅ AutoAdminLogon = 1 (已启用)
# ✅ DefaultUserName = kiosk
# ✅ Shell = C:\kiosk\dreambook\dreambook.exe
# ✅ TabletInputService 运行中
# ✅ 文件存在：C:\kiosk\dreambook\dreambook.exe
```

---

### 阶段 3：应用部署

#### 步骤 3.1：创建应用目录

```cmd
# 以管理员身份运行 PowerShell

# 创建目录
New-Item -ItemType Directory -Path "C:\kiosk\dreambook" -Force

# 验证目录
dir C:\kiosk\dreambook
```

---

#### 步骤 3.2：复制应用文件

```cmd
# 从开发机复制 exe 文件到目标设备
Copy-Item -Path "dist/DreamBook Setup x.x.x.exe" -Destination "C:\kiosk\dreambook\" -Force

# 或者直接复制解压后的文件
Copy-Item -Path "dist/DreamBook x.x.x.exe" -Destination "C:\kiosk\dreambook\dreambook.exe" -Force

# 验证文件
dir C:\kiosk\dreambook\dreambook.exe
```

---

#### 步骤 3.3：设置文件权限

```cmd
# 给 kiosk 用户添加读取权限
icacls "C:\kiosk\dreambook" /grant "kiosk:(OI)(CI)F" /T

# 验证权限
icacls "C:\kiosk\dreambook"
```

---

#### 步骤 3.4：创建快捷方式（可选）

```cmd
# 创建桌面快捷方式
$WshShell = New-Object -ComObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut("$env:USERPROFILE\Desktop\DreamBook.lnk")
$Shortcut.TargetPath = "C:\kiosk\dreambook\dreambook.exe"
$Shortcut.WorkingDirectory = "C:\kiosk\dreambook"
$Shortcut.Save()
```

---

### 阶段 4：首次启动和测试

#### 步骤 4.1：首次启动

```cmd
# 方法 1：直接运行
C:\kiosk\dreambook\dreambook.exe

# 方法 2：通过快捷方式
# 双击桌面上的 DreamBook 快捷方式

# 方法 3：重启电脑（自动启动）
Restart-Computer
```

**预期行为：**
- 应用启动
- 显示 DreamBook 界面
- 后端服务启动
- 虚拟键盘服务就绪

---

#### 步骤 4.2：功能测试

**测试 1：虚拟键盘**
```
1. 点击搜索框
2. 虚拟键盘应该弹出
3. 使用虚拟键盘输入文字
4. 文字应该出现在输入框中
✅ 通过
```

**测试 2：管理面板**
```
1. 在屏幕右上角快速点击 5 次
2. 管理面板应该弹出
3. 点击各个按钮测试功能
✅ 通过
```

**测试 3：切换用户**
```
1. 打开管理面板
2. 点击"切换用户"
3. 确认对话框
4. 应用应该退出到登录界面
5. 可以登录 Administrator 账户
✅ 通过
```

**测试 4：AI 解梦**
```
1. 输入梦境描述
2. 点击"开始解析"
3. 应该显示 AI 解析结果
✅ 通过
```

---

#### 步骤 4.3：性能测试

```cmd
# 监控应用性能
# 打开任务管理器 (Ctrl+Shift+Esc)
# 查看 DreamBook 进程的 CPU 和内存使用

# 预期结果：
# CPU 使用率：< 20%（空闲时）
# 内存使用率：< 300MB（空闲时）
# 内存使用率：< 500MB（运行时）
```

---

#### 步骤 4.4：日志检查

```cmd
# 查看应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" -Tail 100

# 预期内容：
# ✅ 应用启动成功
# ✅ 后端服务启动成功
# ✅ 虚拟键盘服务就绪
# ✅ 没有错误信息
```

---

### 阶段 5：生产环境配置

#### 步骤 5.1：禁用不必要的服务

```cmd
# 禁用 Windows Update（可选）
sc config wuauserv start= disabled

# 禁用 Windows Defender（可选，需要谨慎）
sc config WinDefend start= disabled

# 禁用 Cortana（可选）
sc config CortanaProactive start= disabled
```

---

#### 步骤 5.2：配置防火墙规则

```cmd
# 允许 DreamBook 应用
netsh advfirewall firewall add rule name="Allow DreamBook" dir=in action=allow program="C:\kiosk\dreambook\dreambook.exe"

# 允许后端服务（端口 3000）
netsh advfirewall firewall add rule name="Allow Backend" dir=in action=allow protocol=tcp localport=3000

# 验证规则
netsh advfirewall firewall show rule name="Allow DreamBook"
```

---

#### 步骤 5.3：配置电源管理

```cmd
# 禁用睡眠模式
powercfg /change monitor-timeout-ac 0
powercfg /change disk-timeout-ac 0
powercfg /change standby-timeout-ac 0

# 设置高性能电源计划
powercfg /setactive 8c5e7fda-e8bf-45a6-a6cc-4b3c3f7e5a00

# 验证设置
powercfg /query
```

---

#### 步骤 5.4：配置自动重启

```cmd
# 设置每天凌晨 2 点自动重启
# 打开任务计划程序
taskschd.msc

# 创建新任务：
# 名称：DreamBook Daily Restart
# 触发器：每天 02:00
# 操作：运行 shutdown /r /t 300 /c "Daily maintenance restart"
```

---

### 阶段 6：上线前最终检查

#### 步骤 6.1：完整功能测试

```
□ 开机自动登录
□ 应用自动启动
□ 虚拟键盘正常
□ 管理面板可打开
□ 切换用户功能正常
□ AI 解梦功能正常
□ 没有错误日志
□ 性能指标正常
```

---

#### 步骤 6.2：安全检查

```
□ kiosk 用户没有管理员权限
□ 防火墙规则已配置
□ 不必要的服务已禁用
□ 应用文件权限正确
□ 没有暴露的 API Key
```

---

#### 步骤 6.3：文档准备

```
□ 部署文档已准备
□ 故障排查指南已准备
□ 维护 SOP 已准备
□ 联系方式已记录
□ 备份计划已制定
```

---

## 📊 部署检查表

### 编译阶段

| 项目 | 状态 | 备注 |
|------|------|------|
| 依赖安装 | ⬜ | `yarn install` |
| TypeScript 编译 | ⬜ | `yarn build` |
| Electron 打包 | ⬜ | `yarn electron:build:win` |
| 文件验证 | ⬜ | 检查 dist 目录 |

### 系统配置阶段

| 项目 | 状态 | 备注 |
|------|------|------|
| 创建 kiosk 用户 | ⬜ | `net user kiosk ...` |
| 自动登录配置 | ⬜ | 注册表修改 |
| Shell 替换 | ⬜ | 注册表修改 |
| 虚拟键盘服务 | ⬜ | `sc config TabletInputService` |

### 应用部署阶段

| 项目 | 状态 | 备注 |
|------|------|------|
| 创建应用目录 | ⬜ | `C:\kiosk\dreambook` |
| 复制应用文件 | ⬜ | 复制 exe 文件 |
| 设置文件权限 | ⬜ | `icacls` 命令 |
| 创建快捷方式 | ⬜ | 可选 |

### 测试阶段

| 项目 | 状态 | 备注 |
|------|------|------|
| 首次启动 | ⬜ | 应用正常启动 |
| 虚拟键盘测试 | ⬜ | 点击输入框弹出 |
| 管理面板测试 | ⬜ | 右上角点击 5 次 |
| 切换用户测试 | ⬜ | 退出到登录界面 |
| 性能测试 | ⬜ | CPU/内存正常 |
| 日志检查 | ⬜ | 没有错误 |

### 生产配置阶段

| 项目 | 状态 | 备注 |
|------|------|------|
| 禁用不必要服务 | ⬜ | Windows Update 等 |
| 防火墙规则 | ⬜ | 允许应用和后端 |
| 电源管理 | ⬜ | 禁用睡眠模式 |
| 自动重启 | ⬜ | 每天凌晨 2 点 |

### 上线前检查

| 项目 | 状态 | 备注 |
|------|------|------|
| 功能测试 | ⬜ | 所有功能正常 |
| 安全检查 | ⬜ | 权限和防火墙 |
| 文档准备 | ⬜ | 所有文档就绪 |
| 备份计划 | ⬜ | 备份策略制定 |

---

## 🔄 回滚计划

如果部署出现问题，按以下步骤回滚：

### 快速回滚

```cmd
# 1. 停止应用
taskkill /IM dreambook.exe /F

# 2. 恢复系统配置
.\cleanup-kiosk.bat

# 3. 重启电脑
Restart-Computer
```

### 完整回滚

```cmd
# 1. 删除应用文件
Remove-Item -Path "C:\kiosk\dreambook" -Recurse -Force

# 2. 恢复系统配置
.\cleanup-kiosk.bat

# 3. 恢复防火墙规则
netsh advfirewall firewall delete rule name="Allow DreamBook"
netsh advfirewall firewall delete rule name="Allow Backend"

# 4. 重启电脑
Restart-Computer
```

---

## 📞 部署支持

### 常见问题

**Q：部署过程中应用无法启动？**
A：查看日志文件 `~/dreambook-logs/app-*.log`，搜索错误信息

**Q：虚拟键盘不工作？**
A：运行 `verify-kiosk.bat` 检查 TabletInputService 是否运行

**Q：切换用户功能不工作？**
A：检查 `tsdiscon.exe` 是否存在，运行 `C:\Windows\System32\tsdiscon.exe` 测试

**Q：应用启动后黑屏？**
A：打开 DevTools (F12) 查看错误，检查后端服务是否启动

### 获取帮助

1. 查看故障排查指南
2. 收集诊断信息
3. 查看应用日志
4. 联系技术支持

---

## 📈 部署后监控

### 日常监控

```cmd
# 每天检查应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" | Select-String "错误"

# 监控应用进程
Get-Process dreambook

# 监控系统资源
Get-WmiObject Win32_PerfFormattedData_PerfProc_Process | Where-Object {$_.Name -eq "dreambook"}
```

### 定期维护

```cmd
# 每周清理日志
Remove-Item "$env:USERPROFILE\dreambook-logs\app-*.log" -OlderThan (Get-Date).AddDays(-7)

# 每月检查更新
# 检查是否有新版本可用

# 每季度备份配置
Copy-Item "C:\kiosk\dreambook" -Destination "D:\backup\dreambook-$(Get-Date -Format 'yyyy-MM-dd')" -Recurse
```

---

**最后更新：** 2026-01-13
**版本：** 1.0
**状态：** ✅ 完成
