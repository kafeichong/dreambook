# DreamBook Kiosk 故障诊断决策树

> 基于症状的快速诊断和解决方案流程图

---

## 🔍 快速诊断流程

### 主诊断决策树

```
应用出现问题
    │
    ├──► 无法启动?
    │       │
    │       └──► 见决策树 A: 启动问题
    │
    ├──► 虚拟键盘不工作?
    │       │
    │       └──► 见决策树 B: 虚拟键盘问题
    │
    ├──► 管理面板无法打开?
    │       │
    │       └──► 见决策树 C: 管理面板问题
    │
    ├──► 切换用户不工作?
    │       │
    │       └──► 见决策树 D: 切换用户问题
    │
    ├──► AI 解梦失败?
    │       │
    │       └──► 见决策树 E: AI 服务问题
    │
    └──► 性能问题?
            │
            └──► 见决策树 F: 性能问题
```

---

## 决策树 A: 启动问题

```
应用无法启动
    │
    ├──► 开机后没有自动登录?
    │       │
    │       ├──► 是 → 检查步骤 A1
    │       │       │
    │       │       ├──► 运行: reg query "HKLM\...\Winlogon" /v AutoAdminLogon
    │       │       │       │
    │       │       │       ├──► 结果是 0x1? ──► 是 → 继续检查 A2
    │       │       │       │                   否 → 运行 setup-kiosk.bat 重新配置
    │       │       │
    │       │       └──► A2: 检查默认用户名
    │       │               │
    │       │               ├──► 运行: reg query "HKLM\...\Winlogon" /v DefaultUserName
    │       │               │       │
    │       │               │       ├──► 结果是 kiosk? ──► 是 → 继续检查 A3
    │       │               │       │                      否 → 运行 setup-kiosk.bat
    │       │               │
    │       │               └──► A3: 检查密码配置
    │       │                       │
    │       │                       ├──► 运行: reg query "HKLM\...\Winlogon" /v DefaultPassword
    │       │                       │       │
    │       │                       │       ├──► 有值? ──► 是 → 重启电脑测试
    │       │                       │       │              否 → 运行 setup-kiosk.bat
    │       │                       │
    │       │                       └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    ├──► 自动登录成功，但应用未启动?
    │       │
    │       ├──► 是 → 检查步骤 A4
    │       │       │
    │       │       ├──► 运行: dir C:\kiosk\dreambook\dreambook.exe
    │       │       │       │
    │       │       │       ├──► 文件存在? ──► 是 → 继续检查 A5
    │       │       │       │                  否 → 部署应用文件
    │       │       │
    │       │       └──► A5: 检查 Shell 配置
    │       │               │
    │       │               ├──► 运行: verify-kiosk.bat (检查 Shell)
    │       │               │       │
    │       │               │       ├──► Shell 配置正确? ──► 是 → 检查权限 A6
    │       │               │       │                         否 → 运行 setup-kiosk.bat
    │       │               │
    │       │               └──► A6: 检查文件权限
    │       │                       │
    │       │                       ├──► 运行: icacls C:\kiosk\dreambook
    │       │                       │       │
    │       │                       │       ├──► kiosk 有权限? ──► 是 → 手动启动测试
    │       │                       │       │                      否 → 运行 setup-kiosk.bat
    │       │                       │
    │       │                       └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    └──► 应用启动但黑屏/白屏?
            │
            ├──► 是 → 检查步骤 A7
            │       │
            │       ├──► 按 F12 打开 DevTools
            │       │       │
            │       │       ├──► 有 Console 错误? ──► 是 → 查看错误内容 A8
            │       │       │                         否 → 检查网络 A9
            │       │
            │       ├──► A8: 分析错误类型
            │       │       │
            │       │       ├──► "Cannot connect to backend"? ──► 检查后端服务
            │       │       ├──► "Module not found"? ──► 重新安装依赖
            │       │       └──► "Syntax error"? ──► 重新编译应用
            │       │
            │       └──► A9: 检查网络连接
            │               │
            │               ├──► 运行: curl http://localhost:3000
            │               │       │
            │               │       ├──► 响应正常? ──► 是 → 查看应用日志
            │               │       │                  否 → 启动后端服务
            │               │
            │               └──► ✅ 问题解决
            │
            └──► 否 → 查看详细日志: ~/dreambook-logs/app-*.log
```

---

## 决策树 B: 虚拟键盘问题

```
虚拟键盘不弹出
    │
    ├──► 点击输入框无任何反应?
    │       │
    │       ├──► 是 → 检查步骤 B1
    │       │       │
    │       │       ├──► 打开 DevTools (F12)
    │       │       │       │
    │       │       │       ├──► 查找 "[虚拟键盘]" 日志
    │       │       │       │       │
    │       │       │       │       ├──► 有日志? ──► 是 → 检查日志内容 B2
    │       │       │       │       │              否 → Hook 未触发 B3
    │       │       │       │
    │       │       │       └──► B2: 分析日志错误
    │       │       │               │
    │       │       │               ├──► "非 Windows 平台"? ──► 只能在 Windows 使用
    │       │       │               ├──► "启动失败"? ──► 继续检查 B4
    │       │       │               └──► 其他错误? ──► 查看完整日志
    │       │       │
    │       │       └──► B3: Hook 未触发
    │       │               │
    │       │               ├──► 检查组件是否使用 useVirtualKeyboard
    │       │               ├──► 检查事件绑定: onFocus, onClick, onTouchEnd
    │       │               └──► ✅ 修复后测试
    │       │
    │       └──► 否 → 继续下一步
    │
    ├──► 有日志但键盘未弹出?
    │       │
    │       ├──► 是 → 检查步骤 B4
    │       │       │
    │       │       ├──► 检查 TabletInputService 状态
    │       │       │       │
    │       │       │       ├──► 运行: sc query TabletInputService
    │       │       │       │       │
    │       │       │       │       ├──► 运行中? ──► 是 → 检查 B5
    │       │       │       │       │              否 → 启动服务 B6
    │       │       │       │
    │       │       │       └──► B5: 手动测试 TabTip.exe
    │       │       │               │
    │       │       │               ├──► 运行: "C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"
    │       │       │               │       │
    │       │       │               │       ├──► 弹出? ──► 是 → 应用问题，查看详细日志
    │       │       │               │       │          否 → 系统问题 B7
    │       │       │               │
    │       │       │               └──► B6: 启动服务
    │       │       │                       │
    │       │       │                       ├──► 运行: sc start TabletInputService
    │       │       │                       ├──► 运行: sc config TabletInputService start= auto
    │       │       │                       └──► ✅ 问题解决
    │       │       │
    │       │       └──► B7: 系统组件问题
    │       │               │
    │       │               ├──► 运行: sfc /scannow (修复系统文件)
    │       │               ├──► 或安装 Windows Update
    │       │               └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    └──► 键盘偶尔弹出，偶尔不弹出?
            │
            ├──► 是 → 检查步骤 B8
            │       │
            │       ├──► 检查防抖设置 (500ms)
            │       │       │
            │       │       ├──► 连续点击过快? ──► 是 → 等待 500ms 再试
            │       │       │                      否 → 继续检查 B9
            │       │
            │       └──► B9: 检查系统资源
            │               │
            │               ├──► 打开任务管理器
            │               │       │
            │               │       ├──► CPU > 80%? ──► 是 → 关闭其他程序
            │               │       ├──► 内存 > 90%? ──► 是 → 释放内存
            │               │       └──► 否 → 查看详细日志
            │               │
            │               └──► ✅ 问题解决
            │
            └──► 否 → 联系技术支持
```

---

## 决策树 C: 管理面板问题

```
管理面板无法打开
    │
    ├──► 点击右上角无反应?
    │       │
    │       ├──► 是 → 检查步骤 C1
    │       │       │
    │       │       ├──► 打开 DevTools (F12)
    │       │       │       │
    │       │       │       ├──► 查找 "[AdminTrigger]" 日志
    │       │       │       │       │
    │       │       │       │       ├──► 有日志? ──► 是 → 检查点击计数 C2
    │       │       │       │       │              否 → 触发区域问题 C3
    │       │       │       │
    │       │       │       └──► C2: 分析点击计数
    │       │       │               │
    │       │       │               ├──► 计数增加? ──► 是 → 需要 5 次点击 C4
    │       │       │               │                  否 → 事件未触发 C3
    │       │       │               │
    │       │       │               └──► C3: 检查触发区域
    │       │       │                       │
    │       │       │                       ├──► 在 AdminTrigger.tsx 中:
    │       │       │                       ├──► 取消注释: backgroundColor: 'rgba(255,0,0,0.3)'
    │       │       │                       ├──► 刷新页面
    │       │       │                       ├──► 查看右上角是否有红色区域
    │       │       │                       │       │
    │       │       │                       │       ├──► 有红色? ──► 是 → 点击红色区域测试
    │       │       │                       │       │              否 → zIndex 被覆盖
    │       │       │                       │
    │       │       │                       └──► ✅ 问题解决
    │       │       │
    │       │       └──► C4: 确保 2 秒内点击 5 次
    │       │               │
    │       │               ├──► 快速连续点击 5 次
    │       │               ├──► 查看日志中的时间间隔
    │       │               └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    ├──► 面板打开但按钮不工作?
    │       │
    │       ├──► 是 → 检查步骤 C5
    │       │       │
    │       │       ├──► 哪个按钮不工作?
    │       │       │       │
    │       │       │       ├──► "刷新页面" → 直接刷新浏览器测试
    │       │       │       │
    │       │       │       ├──► "重启应用" → 检查 window.electronAPI.restartApp
    │       │       │       │       │
    │       │       │       │       ├──► 运行: window.electronAPI?.restartApp
    │       │       │       │       │       │
    │       │       │       │       │       ├──► 有提示? ──► 是 → IPC 工作 C6
    │       │       │       │       │       │              否 → API 未定义
    │       │       │       │       │
    │       │       │       │       └──► C6: 检查主进程
    │       │       │       │               │
    │       │       │       │               ├──► 查看日志: ~/dreambook-logs/app-*.log
    │       │       │       │               ├──► 搜索 "重启应用"
    │       │       │       │               └──► ✅ 问题解决
    │       │       │       │
    │       │       │       ├──► "退出应用" → 类似"重启应用"检查
    │       │       │       │
    │       │       │       └──► "切换用户" → 见决策树 D
    │       │       │
    │       │       └──► 继续下一步
    │       │
    │       └──► 否 → 继续下一步
    │
    └──► 其他问题?
            │
            └──► 查看详细日志或联系技术支持
```

---

## 决策树 D: 切换用户问题

```
切换用户不工作
    │
    ├──► 点击"切换用户"无反应?
    │       │
    │       ├──► 是 → 检查步骤 D1
    │       │       │
    │       │       ├──► 确认对话框弹出?
    │       │       │       │
    │       │       │       ├──► 是 → 点击"确定"后继续检查 D2
    │       │       │       │
    │       │       │       └──► 否 → 检查 D3
    │       │       │               │
    │       │       │               ├──► 打开 DevTools Console
    │       │       │               ├──► 查找错误信息
    │       │       │               │       │
    │       │       │               │       ├──► "switchUser is not a function"? ──► preload.ts 未正确配置
    │       │       │               │       └──► 其他错误? ──► 查看详细错误
    │       │       │               │
    │       │       │               └──► ✅ 修复后测试
    │       │       │
    │       │       └──► D2: 检查 IPC 通信
    │       │               │
    │       │               ├──► 查看日志: ~/dreambook-logs/app-*.log
    │       │               ├──► 搜索 "[系统] 执行切换用户命令"
    │       │               │       │
    │       │               │       ├──► 有日志? ──► 是 → 继续检查 D4
    │       │               │       │              否 → IPC 未触发 D3
    │       │               │
    │       │               └──► D3: 检查 preload 和 main
    │       │                       │
    │       │                       ├──► 确认 preload.ts 已添加 switchUser
    │       │                       ├──► 确认 main.ts 已添加 IPC handler
    │       │                       ├──► 重新编译应用
    │       │                       └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    ├──► IPC 触发但未退出?
    │       │
    │       ├──► 是 → 检查步骤 D4
    │       │       │
    │       │       ├──► 查看日志中的错误
    │       │       │       │
    │       │       │       ├──► "切换用户失败"? ──► 检查 D5
    │       │       │       │       │
    │       │       │       │       └──► D5: 检查 tsdiscon.exe
    │       │       │       │               │
    │       │       │       │               ├──► 运行: dir C:\Windows\System32\tsdiscon.exe
    │       │       │       │               │       │
    │       │       │       │               │       ├──► 文件存在? ──► 是 → 手动测试 D6
    │       │       │       │               │       │                  否 → 系统文件缺失
    │       │       │       │               │
    │       │       │       │               └──► D6: 手动测试命令
    │       │       │       │                       │
    │       │       │       │                       ├──► 运行: C:\Windows\System32\tsdiscon.exe
    │       │       │       │                       │       │
    │       │       │       │                       │       ├──► 退出到登录界面? ──► 是 → 应用问题
    │       │       │       │                       │       │                         否 → 权限问题 D7
    │       │       │       │                       │
    │       │       │       │                       └──► D7: 检查权限
    │       │       │       │                               │
    │       │       │       │                               ├──► 以管理员身份运行应用测试
    │       │       │       │                               └──► ✅ 问题解决
    │       │       │       │
    │       │       │       ├──► "非 Windows 平台"? ──► 只能在 Windows 使用
    │       │       │       │
    │       │       │       └──► 其他错误? ──► 查看完整错误信息
    │       │       │
    │       │       └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    └──► 退出后无法登录其他账户?
            │
            ├──► 是 → 检查步骤 D8
            │       │
            │       ├──► 验证其他账户是否存在
            │       ├──► 验证账户密码是否正确
            │       └──► ✅ 问题解决
            │
            └──► 否 → 功能正常
```

---

## 决策树 E: AI 服务问题

```
AI 解梦功能失败
    │
    ├──► 点击"开始解析"无反应?
    │       │
    │       ├──► 是 → 检查步骤 E1
    │       │       │
    │       │       ├──► 打开 DevTools Network 标签
    │       │       │       │
    │       │       │       ├──► 有请求发出? ──► 是 → 检查请求状态 E2
    │       │       │       │                  否 → 前端问题 E3
    │       │       │       │
    │       │       │       └──► E2: 分析请求状态
    │       │       │               │
    │       │       │               ├──► 状态码 200? ──► 是 → 后端正常 E4
    │       │       │               ├──► 状态码 500? ──► 后端错误 E5
    │       │       │               ├──► 状态码 404? ──► 路由错误 E6
    │       │       │               └──► 无响应? ──► 后端未启动 E7
    │       │       │
    │       │       └──► E3: 前端问题
    │       │               │
    │       │               ├──► 检查 Console 错误
    │       │               ├──► 验证输入内容不为空
    │       │               └──► ✅ 修复后测试
    │       │
    │       └──► 否 → 继续下一步
    │
    ├──► 请求发出但返回错误?
    │       │
    │       ├──► 是 → 检查步骤 E4
    │       │       │
    │       │       ├──► E4: 检查响应内容
    │       │       │       │
    │       │       │       ├──► 查看 Network Response
    │       │       │       │       │
    │       │       │       │       ├──► "API key invalid"? ──► 检查 E8
    │       │       │       │       ├──► "Rate limit exceeded"? ──► 等待或升级
    │       │       │       │       ├──► "Timeout"? ──► 网络问题 E9
    │       │       │       │       └──► 其他错误? ──► 查看详细错误
    │       │       │       │
    │       │       │       └──► E5: 后端错误
    │       │       │               │
    │       │       │               ├──► 查看后端日志
    │       │       │               ├──► 重启后端服务
    │       │       │               └──► ✅ 问题解决
    │       │       │
    │       │       ├──► E6: 路由错误
    │       │       │       │
    │       │       │       ├──► 检查 API 路径: /api/dream-chat
    │       │       │       ├──► 检查后端路由配置
    │       │       │       └──► ✅ 问题解决
    │       │       │
    │       │       ├──► E7: 后端未启动
    │       │       │       │
    │       │       │       ├──► 运行: curl http://localhost:3000
    │       │       │       │       │
    │       │       │       │       ├──► 无响应? ──► 启动后端服务
    │       │       │       │       └──► 有响应? ──► 端口正确
    │       │       │       │
    │       │       │       └──► ✅ 问题解决
    │       │       │
    │       │       ├──► E8: API Key 问题
    │       │       │       │
    │       │       │       ├──► 检查 backend/.env 文件
    │       │       │       ├──► 验证 DEEPSEEK_API_KEY
    │       │       │       ├──► 测试 API Key 有效性
    │       │       │       └──► ✅ 问题解决
    │       │       │
    │       │       └──► E9: 网络问题
    │       │               │
    │       │               ├──► 检查网络连接
    │       │               ├──► 检查防火墙设置
    │       │               ├──► 测试外网访问
    │       │               └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    └──► 返回结果但内容异常?
            │
            ├──► 是 → 检查步骤 E10
            │       │
            │       ├──► 结果为空? ──► AI 模型问题，更换 prompt
            │       ├──► 结果乱码? ──► 编码问题，检查字符集
            │       └──► 结果不相关? ──► Prompt 需要优化
            │
            └──► 否 → 功能正常
```

---

## 决策树 F: 性能问题

```
应用性能异常
    │
    ├──► 启动很慢 (>60秒)?
    │       │
    │       ├──► 是 → 检查步骤 F1
    │       │       │
    │       │       ├──► 打开任务管理器
    │       │       │       │
    │       │       │       ├──► 磁盘使用率 > 90%? ──► 是 → 清理磁盘 F2
    │       │       │       ├──► CPU 使用率 > 80%? ──► 关闭其他程序
    │       │       │       ├──► 内存使用率 > 90%? ──► 释放内存
    │       │       │       └──► 否 → 检查应用本身 F3
    │       │       │
    │       │       ├──► F2: 清理磁盘
    │       │       │       │
    │       │       │       ├──► 删除临时文件
    │       │       │       ├──► 清理应用日志
    │       │       │       ├──► 运行磁盘清理工具
    │       │       │       └──► ✅ 问题解决
    │       │       │
    │       │       └──► F3: 优化应用
    │       │               │
    │       │               ├──► 清理 node_modules 重新安装
    │       │               ├──► 重新编译应用
    │       │               ├──► 禁用不必要的动画
    │       │               └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    ├──► 运行时卡顿?
    │       │
    │       ├──► 是 → 检查步骤 F4
    │       │       │
    │       │       ├──► 打开 DevTools Performance 标签
    │       │       │       │
    │       │       │       ├──► 录制性能分析
    │       │       │       ├──► 查找性能瓶颈
    │       │       │       │       │
    │       │       │       │       ├──► 渲染时间长? ──► 优化组件 F5
    │       │       │       │       ├──► 脚本执行慢? ──► 优化代码 F6
    │       │       │       │       └──► 网络请求慢? ──► 优化后端 F7
    │       │       │       │
    │       │       │       └──► F5: 优化渲染
    │       │       │               │
    │       │       │               ├──► 减少重渲染
    │       │       │               ├──► 使用 React.memo
    │       │       │               ├──► 虚拟化长列表
    │       │       │               └──► ✅ 问题解决
    │       │       │
    │       │       ├──► F6: 优化代码
    │       │       │       │
    │       │       │       ├──► 优化算法复杂度
    │       │       │       ├──► 使用 Web Worker
    │       │       │       ├──► 延迟加载
    │       │       │       └──► ✅ 问题解决
    │       │       │
    │       │       └──► F7: 优化后端
    │       │               │
    │       │               ├──► 增加缓存
    │       │               ├──► 优化数据库查询
    │       │               ├──► 减少 API 调用
    │       │               └──► ✅ 问题解决
    │       │
    │       └──► 否 → 继续下一步
    │
    └──► 内存泄漏?
            │
            ├──► 是 → 检查步骤 F8
            │       │
            │       ├──► 打开 DevTools Memory 标签
            │       ├──► 录制内存快照
            │       ├──► 查找泄漏点
            │       │       │
            │       │       ├──► 事件监听器未清理? ──► 添加 cleanup
            │       │       ├──► 定时器未清理? ──► clearInterval/clearTimeout
            │       │       ├──► 闭包引用? ──► 优化代码结构
            │       │       └──► 其他问题? ──► 详细分析
            │       │
            │       └──► ✅ 问题解决
            │
            └──► 否 → 性能正常
```

---

## 📞 快速参考

### 常用诊断命令

```cmd
# 检查服务状态
sc query TabletInputService

# 检查注册表
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"

# 检查文件权限
icacls C:\kiosk\dreambook

# 检查网络连接
curl http://localhost:3000

# 查看应用日志
Get-Content ~/dreambook-logs/app-*.log -Tail 100

# 验证配置
.\verify-kiosk.bat
```

---

**最后更新:** 2026-01-13
**版本:** 1.0
**状态:** ✅ 完成
