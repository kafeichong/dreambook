好，这里我给你一份**“已经验证可行”的完整 Kiosk 实现备份文档**。
不再讨论方案选择、不再解释原理，只记录 **你现在这台机器是怎么一步一步成功跑起来的**，方便你以后：

* 重装系统后复刻
* 换设备部署
* 给同事 / 客户交付
* 自己半年后回看也不懵

---

# ✅ Win10 + Electron 触摸屏

## Kiosk（Shell 替换）成功实现完整步骤备份

> **最终效果**
>
> * 开机不需要输入密码
> * 自动进入 Electron 程序
> * 无任务栏 / 无开始菜单 / 无 Explorer
> * 触摸屏可输入（弹虚拟键盘）
> * 管理员可通过隐藏入口切换用户、关机维护

---

## 一、系统与前提条件

* 系统：**Windows 10 19042（已验证）**

* 应用：Electron（Win32）

* 设备：触摸屏

* 账户规划：

  * `Administrator`：管理员 / 维护
  * `kiosk`：终端使用账户（非管理员）

* 程序路径（已固定）：

```
C:\kiosk\dreambook\dreambook.exe
```

---

## 二、创建 kiosk 用户（如尚未创建）

管理员 CMD 执行：

```bat
net user kiosk YOUR_KIOSK_PASSWORD /add
```

（kiosk 是普通用户即可，不要给管理员权限）

---

## 三、核心步骤：Shell 替换（Kiosk 的关键）

> **原则：**
>
> * kiosk 用户 ≠ Windows 桌面
> * kiosk 的 Shell = dreambook.exe
> * explorer.exe 永远不启动

### 3.1 kiosk 还未登录过 → 修改 Default User 模板（已验证可行）

管理员 CMD 执行：

```bat
reg load HKU\DEF "C:\Users\Default\NTUSER.DAT"
reg add "HKU\DEF\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
 /v Shell /t REG_SZ /d "C:\kiosk\dreambook\dreambook.exe" /f
reg unload HKU\DEF
```

> 说明：
>
> * kiosk 第一次登录时会从 Default User 复制 NTUSER.DAT
> * 从而自动继承 `Shell=dreambook.exe`

---

## 四、设置开机自动登录（不输入密码）

管理员 CMD 执行（一次性）：

```bat
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
 /v DefaultUserName /t REG_SZ /d kiosk /f

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
 /v DefaultPassword /t REG_SZ /d "YOUR_KIOSK_PASSWORD" /f

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
 /v AutoAdminLogon /t REG_SZ /d 1 /f
```

**结果：**

* 开机 → 自动登录 kiosk
* 直接进入 dreambook.exe
* 不出现登录界面

---

## 五、Electron 必须做的关键修改（否则会黑屏）

### 5.1 禁止“真正退出程序”

**原因**：
Shell = 程序，一旦退出就没有系统界面 → 黑屏（这是正常现象）

### 5.2 主进程（main.ts）兜底逻辑（已验证）

```ts
let win: BrowserWindow | null = null;

function createWindow() {
  win = new BrowserWindow({
    fullscreen: true,
    kiosk: true,
    frame: false,
    autoHideMenuBar: true,
    resizable: false,
    movable: false,
  });

  // win.loadURL / loadFile ...
}

app.whenReady().then(createWindow);

// 任何原因窗口被关 → 立刻重建
app.on("window-all-closed", () => {
  createWindow();
});

app.on("browser-window-created", (_, w) => {
  w.on("closed", () => {
    win = null;
    createWindow();
  });
});
```

**结果：**

* 用户误操作 / 程序异常
* 窗口会立即重新打开
* 永不黑屏

---

## 六、触摸屏输入：点击输入框弹出虚拟键盘（已解决）

### 6.1 启用系统服务（一次性）

管理员 CMD：

```bat
sc config TabletInputService start= auto
sc start TabletInputService
```

---

### 6.2 Electron 主进程：调用 Windows 触摸键盘

```ts
import { ipcMain } from "electron";
import { exec } from "child_process";

ipcMain.handle("kb:show", () => {
  exec(`"%ProgramFiles%\\Common Files\\microsoft shared\\ink\\TabTip.exe"`);
});
```

---

### 6.3 preload.js 暴露接口

```ts
contextBridge.exposeInMainWorld("kb", {
  show: () => ipcRenderer.invoke("kb:show"),
});
```

---

### 6.4 前端输入框

```tsx
<input onFocus={() => window.kb?.show?.()} />
```

**结果：**

* 触摸点击输入框
* 系统虚拟键盘自动弹出
* 不依赖 explorer

---

## 七、管理员维护入口（5 次点击右上角）

### 7.1 前端隐藏热区逻辑

* 右上角 80×80 区域
* 2 秒内点击 ≥5 次
* 弹出“维护弹窗”

---

### 7.2 维护操作：切换用户（不是退出程序）

主进程：

```ts
import { exec } from "child_process";

ipcMain.handle("sys:switchUser", () => {
  exec("C:\\Windows\\System32\\tsdiscon.exe");
});
```

前端点击：

```ts
window.sys.switchUser();
```

**结果：**

* 程序退出到登录界面
* 可切换到 Administrator
* 管理员正常关机 / 维护 / 更新程序

---

## 八、管理员的标准维护 SOP（交付级）

1. 右上角点击 5 次
2. 弹出维护弹窗 → 点击“退出并切换用户”
3. 进入 Windows 登录界面
4. 登录 `Administrator`
5. 关机 / 重启 / 更新 / 调试
6. 重启后系统自动回到 kiosk 程序

---

## 九、为什么不用 Assigned Access（结论）

* Win10 19042 + Win32 / Electron
* Assigned Access / MDM 支持 **不稳定且不可控**
* Shell 替换方案：

  * 不依赖版本
  * 不依赖 MDM
  * 不依赖系统 UI
  * **真实项目中最稳**

---

## 十、最终一句总结（给未来的自己）

> **kiosk 的本质不是“隐藏任务栏”，而是“根本不启动 Windows 桌面”。**
> **程序 = 系统，管理员通过“切换用户”维护。**

---
