# DreamBook Kiosk 故障排查指南

> 详细的问题诊断和解决方案

---

## 🔍 问题诊断流程

```
问题出现
    ↓
查看日志文件 → ~/dreambook-logs/app-YYYY-MM-DD.log
    ↓
打开 DevTools → F12 (开发模式)
    ↓
查看 Console 输出 → 搜索 [错误] 或 [虚拟键盘]
    ↓
对照下面的问题列表 → 找到对应解决方案
    ↓
执行解决方案
    ↓
验证问题是否解决
```

---

## 🚨 常见问题及解决方案

### 问题 1：开机后没有自动登录

**症状：**
- 重启电脑后显示 Windows 登录界面
- 需要手动输入 kiosk 用户名和密码

**可能原因：**
1. 自动登录注册表配置不正确
2. 密码包含特殊字符导致注册表写入失败
3. 组策略禁用了自动登录

**诊断步骤：**

```cmd
# 1. 检查注册表配置
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword

# 预期输出：
# AutoAdminLogon = 1
# DefaultUserName = kiosk
# DefaultPassword = your_password
```

**解决方案：**

```cmd
# 方案 1：重新配置自动登录
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v AutoAdminLogon /t REG_SZ /d 1 /f

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v DefaultUserName /t REG_SZ /d kiosk /f

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v DefaultPassword /t REG_SZ /d "your_password" /f

# 方案 2：如果密码包含特殊字符，使用不包含特殊字符的密码
# 或者使用 PowerShell 脚本处理特殊字符

# 方案 3：检查组策略
gpedit.msc
# 导航到：计算机配置 → Windows 设置 → 安全设置 → 本地策略 → 安全选项
# 查找"交互式登录：不需要按 Ctrl+Alt+Delete"
# 确保已启用
```

**验证：**
```cmd
# 重启电脑
Restart-Computer

# 应该自动登录到 kiosk 账户
```

---

### 问题 2：虚拟键盘不弹出

**症状：**
- 点击输入框时虚拟键盘没有出现
- 无法使用触摸屏输入文字

**可能原因：**
1. TabletInputService 服务未启用
2. TabTip.exe 文件不存在或损坏
3. 防火墙阻止了虚拟键盘进程
4. 应用窗口设置为完全全屏（Windows 会禁用虚拟键盘）

**诊断步骤：**

```cmd
# 1. 检查 TabletInputService 服务状态
sc query TabletInputService

# 预期输出：
# STATE : 4 RUNNING

# 2. 检查 TabTip.exe 文件
dir "C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"
dir "C:\Program Files (x86)\Common Files\microsoft shared\ink\TabTip.exe"

# 3. 手动测试虚拟键盘
"C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"

# 4. 查看应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" | Select-String "虚拟键盘"
```

**解决方案：**

```cmd
# 方案 1：启用 TabletInputService 服务
sc config TabletInputService start= auto
sc start TabletInputService

# 方案 2：重启 TabletInputService 服务
sc stop TabletInputService
sc start TabletInputService

# 方案 3：检查防火墙规则
netsh advfirewall firewall show rule name="TabTip" verbose

# 如果被阻止，添加规则
netsh advfirewall firewall add rule name="Allow TabTip" dir=in action=allow program="C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"

# 方案 4：修改应用窗口设置
# 编辑 electron/main.ts，确保不使用完全全屏
# 使用"伪全屏"模式（高度减 1 像素）
```

**验证：**
```cmd
# 1. 重启应用
# 2. 点击输入框
# 3. 虚拟键盘应该弹出

# 如果还是不行，查看日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" -Tail 50
```

---

### 问题 3：切换用户不工作

**症状：**
- 点击"切换用户"按钮后没有反应
- 应用没有退出到登录界面

**可能原因：**
1. tsdiscon.exe 文件不存在或路径错误
2. kiosk 用户没有权限执行 tsdiscon.exe
3. 应用没有正确调用 IPC 处理器

**诊断步骤：**

```cmd
# 1. 检查 tsdiscon.exe 文件
dir C:\Windows\System32\tsdiscon.exe

# 2. 手动测试切换用户
C:\Windows\System32\tsdiscon.exe

# 3. 查看应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" | Select-String "切换用户"

# 4. 打开 DevTools 查看 Console
# F12 → Console → 搜索 "switchUser"
```

**解决方案：**

```cmd
# 方案 1：检查文件权限
icacls C:\Windows\System32\tsdiscon.exe

# 方案 2：给 kiosk 用户添加权限
icacls C:\Windows\System32\tsdiscon.exe /grant "kiosk:(F)"

# 方案 3：使用替代命令
# 编辑 electron/main.ts，使用 logoff 命令替代
# exec('logoff', (error) => { ... })

# 方案 4：检查 IPC 处理器是否正确注册
# 在 electron/main.ts 中搜索 'sys:switch-user'
# 确保 ipcMain.handle 已正确定义
```

**验证：**
```cmd
# 1. 打开应用
# 2. 右上角点击 5 次打开管理面板
# 3. 点击"切换用户"
# 4. 应该退出到登录界面
```

---

### 问题 4：右上角点击不响应

**症状：**
- 右上角点击 5 次没有打开管理面板
- 管理面板无法打开

**可能原因：**
1. 触发区域被其他元素覆盖
2. zIndex 设置不正确
3. 点击事件没有正确传递
4. 点击计数逻辑有问题

**诊断步骤：**

```typescript
// 1. 打开 DevTools (F12)
// 2. 在 Console 中查看日志
// 搜索 "[AdminTrigger]"

// 3. 取消注释调试代码查看触发区域
// 编辑 src/components/AdminTrigger/AdminTrigger.tsx
// 取消注释：backgroundColor: 'rgba(255, 0, 0, 0.3)',

// 4. 查看红色区域是否在右上角
```

**解决方案：**

```typescript
// 方案 1：检查 zIndex
// 确保 AdminTrigger 的 zIndex 足够高
// 当前设置：zIndex: 99999

// 方案 2：检查点击事件处理
// 在 AdminTrigger.tsx 中添加日志
console.log('[AdminTrigger] 点击事件触发', e)

// 方案 3：增加触发区域大小（调试用）
// 临时修改宽度和高度
width: '200px',  // 从 80px 改为 200px
height: '200px', // 从 80px 改为 200px

// 方案 4：检查触摸事件
// 确保同时处理 onClick 和 onTouchEnd
```

**验证：**
```typescript
// 1. 打开应用
// 2. 打开 DevTools (F12)
// 3. 在右上角快速点击 5 次
// 4. 查看 Console 中的日志
// 应该看到：[AdminTrigger] 点击检测 { clickCount: 1, triggerClicks: 5 }
// 5. 管理面板应该弹出
```

---

### 问题 5：应用启动后黑屏

**症状：**
- 应用启动但显示黑屏
- 无法看到任何内容

**可能原因：**
1. HTML 文件加载失败
2. 后端服务未启动
3. 渲染进程崩溃
4. 资源路径错误

**诊断步骤：**

```cmd
# 1. 查看应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" -Tail 100

# 2. 打开 DevTools (F12)
# 查看 Console 中的错误信息

# 3. 检查后端服务
netstat -ano | findstr :3000

# 4. 手动启动后端测试
curl http://localhost:3000/health
```

**解决方案：**

```cmd
# 方案 1：检查 HTML 文件
dir "C:\path\to\app\dist\index.html"

# 方案 2：启动后端服务
cd backend
npm run dev

# 方案 3：检查资源路径
# 编辑 electron/main.ts
# 确保 htmlPath 正确
const htmlPath = join(app.getAppPath(), 'dist', 'index.html')

# 方案 4：启用 DevTools 查看错误
# 编辑 electron/main.ts
const ENABLE_DEVTOOLS_IN_PRODUCTION = true
```

**验证：**
```cmd
# 1. 重启应用
# 2. 应该看到应用界面
# 3. 如果还是黑屏，查看 DevTools Console
```

---

### 问题 6：应用卡死或无响应

**症状：**
- 应用界面冻结
- 无法点击任何按钮
- 需要强制关闭

**可能原因：**
1. 后端服务响应缓慢
2. 前端 JavaScript 执行出错
3. 内存泄漏
4. 网络连接问题

**诊断步骤：**

```cmd
# 1. 查看应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" -Tail 100

# 2. 打开 DevTools (F12)
# 查看 Console 中的错误

# 3. 检查后端服务
curl http://localhost:3000/health

# 4. 查看内存使用
tasklist /v | findstr dreambook

# 5. 查看网络连接
netstat -ano | findstr dreambook
```

**解决方案：**

```cmd
# 方案 1：重启应用
# 右上角点击 5 次 → 点击"重启应用"

# 方案 2：重启后端服务
taskkill /IM backend.exe /F
# 然后重启应用

# 方案 3：清理缓存
# 删除 %APPDATA%\dreambook 目录

# 方案 4：增加超时时间
# 编辑 backend/src/index.ts
// 增加 API 超时时间
app.use(express.json({ limit: '50mb' }))
```

**验证：**
```cmd
# 1. 重启应用
# 2. 尝试使用应用
# 3. 应该正常响应
```

---

### 问题 7：虚拟键盘输入不工作

**症状：**
- 虚拟键盘弹出但无法输入
- 点击虚拟键盘按键没有反应

**可能原因：**
1. 输入框没有获得焦点
2. 输入框被禁用
3. 虚拟键盘进程与应用进程通信失败

**诊断步骤：**

```typescript
// 1. 打开 DevTools (F12)
// 2. 在 Console 中执行
document.activeElement  // 应该显示 input 或 textarea 元素

// 3. 检查输入框属性
document.querySelector('input').disabled  // 应该是 false

// 4. 查看虚拟键盘进程
tasklist | findstr TabTip
```

**解决方案：**

```typescript
// 方案 1：确保输入框获得焦点
// 在 useVirtualKeyboard Hook 中添加
setTimeout(() => {
  document.activeElement?.focus()
}, 100)

// 方案 2：检查输入框是否被禁用
// 在 SearchBox 或 AIChat 中
<input disabled={loading} />  // 确保 loading 为 false

// 方案 3：重新启动虚拟键盘
taskkill /IM TabTip.exe /F
// 然后点击输入框重新启动

// 方案 4：使用 osk.exe 替代
// 编辑 electron/main.ts
// 在 showWindowsVirtualKeyboard 中优先使用 osk.exe
```

**验证：**
```typescript
// 1. 打开应用
// 2. 点击输入框
// 3. 虚拟键盘弹出
// 4. 点击虚拟键盘按键
// 5. 文字应该出现在输入框中
```

---

### 问题 8：后端服务启动失败

**症状：**
- 应用启动时显示"后端服务启动失败"
- 无法调用 AI 解梦功能

**可能原因：**
1. 端口 3000 被占用
2. 后端可执行文件不存在或损坏
3. API Key 配置错误
4. 网络连接问题

**诊断步骤：**

```cmd
# 1. 检查端口 3000 是否被占用
netstat -ano | findstr :3000

# 2. 检查后端可执行文件
dir "C:\path\to\resources\backend\backend.exe"

# 3. 手动启动后端
C:\path\to\resources\backend\backend.exe

# 4. 测试后端健康检查
curl http://localhost:3000/health

# 5. 查看应用日志
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" | Select-String "后端"
```

**解决方案：**

```cmd
# 方案 1：释放端口 3000
# 找到占用端口的进程
netstat -ano | findstr :3000
# 假设 PID 是 1234
taskkill /PID 1234 /F

# 方案 2：检查后端可执行文件
# 确保 backend.exe 存在且完整
# 如果损坏，重新编译
cd backend
npm run build

# 方案 3：配置 API Key
# 编辑 electron/main.ts
const DEEPSEEK_API_KEY = 'sk-your-api-key-here'

# 方案 4：增加后端启动超时时间
# 编辑 electron/main.ts
const maxRetries = 30  // 从 15 改为 30
```

**验证：**
```cmd
# 1. 重启应用
# 2. 查看日志中是否显示"后端服务启动成功"
# 3. 尝试使用 AI 解梦功能
```

---

## 📊 日志分析指南

### 日志文件位置

```
Windows: %USERPROFILE%\dreambook-logs\app-YYYY-MM-DD.log
macOS:   ~/dreambook-logs/app-YYYY-MM-DD.log
Linux:   ~/dreambook-logs/app-YYYY-MM-DD.log
```

### 查看日志

```cmd
# Windows PowerShell
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" -Tail 100

# macOS/Linux
tail -f ~/dreambook-logs/app-*.log

# 搜索特定错误
Get-Content "$env:USERPROFILE\dreambook-logs\app-*.log" | Select-String "错误"
```

### 常见日志标记

| 标记 | 含义 | 示例 |
|------|------|------|
| `[虚拟键盘]` | 虚拟键盘相关 | `[虚拟键盘] 已启动 TabTip.exe` |
| `[AdminTrigger]` | 管理面板触发 | `[AdminTrigger] 点击检测` |
| `[系统]` | 系统命令 | `[系统] 执行切换用户命令` |
| `[后端]` | 后端服务 | `[后端] 服务启动成功` |
| `❌` | 错误 | `❌ 后端服务启动失败` |
| `✅` | 成功 | `✅ 虚拟键盘已启动` |

---

## 🔧 高级调试技巧

### 启用详细日志

```typescript
// 编辑 electron/main.ts
// 在 log 函数中添加时间戳和详细信息
function log(message: string, level: 'info' | 'warn' | 'error' = 'info'): void {
  const timestamp = new Date().toISOString()
  const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}\n`
  console.log(message)
  logStream?.write(logMessage)
}
```

### 远程调试

```cmd
# 1. 启用 DevTools
# 编辑 electron/main.ts
const ENABLE_DEVTOOLS_IN_PRODUCTION = true

# 2. 使用 Chrome DevTools Protocol
# 在另一台电脑上访问
http://device-ip:9222

# 3. 查看远程调试信息
```

### 性能分析

```typescript
// 在 DevTools 中使用 Performance 标签
// 1. 打开 DevTools (F12)
// 2. 切换到 Performance 标签
// 3. 点击录制按钮
// 4. 执行操作
// 5. 停止录制
// 6. 分析性能瓶颈
```

---

## 📞 获取帮助

### 收集诊断信息

```cmd
# 1. 收集日志文件
Copy-Item "$env:USERPROFILE\dreambook-logs\app-*.log" -Destination "C:\Temp\logs\"

# 2. 收集系统信息
systeminfo > C:\Temp\systeminfo.txt

# 3. 收集网络信息
ipconfig /all > C:\Temp\network.txt

# 4. 收集进程信息
tasklist /v > C:\Temp\processes.txt

# 5. 打包所有信息
Compress-Archive -Path "C:\Temp\*" -DestinationPath "C:\Temp\diagnostics.zip"
```

### 联系技术支持

提供以下信息：
1. 诊断信息包（diagnostics.zip）
2. 问题描述和重现步骤
3. 预期结果和实际结果
4. 已尝试的解决方案

---

**最后更新：** 2026-01-13
**版本：** 1.0
**状态：** ✅ 完成
