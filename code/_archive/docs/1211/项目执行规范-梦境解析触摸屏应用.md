# 梦境解析触摸屏应用 · 项目执行规范

> **项目名称：** 情绪星球 Emotion Planet - 梦境解析系统
> **运行环境：** 图书馆触摸屏设备（Windows 10，1920×1080，Electron 全屏）
> **技术栈：** React + Vite + GSAP + Three.js (可选) + Electron
> **文档版本：** v1.0
> **最后更新：** 2025-11-30

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术架构决策](#2-技术架构决策)
3. [性能优化策略](#3-性能优化策略)
4. [动效设计规范](#4-动效设计规范)
5. [Three.js 可选方案](#5-threejs-可选方案)
6. [开发优先级](#6-开发优先级)
7. [测试验收标准](#7-测试验收标准)

---

## 1. 项目概述

### 1.1 项目背景
- **使用场景：** 图书馆公共触摸屏，全天候运行（8:00-22:00，约14小时）
- **目标用户：** 图书馆访客，主要是学生和读者
- **核心功能：** 梦境解析、情绪分析、心理健康建议

### 1.2 设计风格关键词
**霓散光 · 梦境 · 柔和 · 缓慢 · 安静 · 有情绪**

### 1.3 核心页面结构
```
首页 (首页.jpg)
  ↓ [点击开始探索]
导航页 (导航.jpg)
  ↓ [选择梦境类型]
详情页 (详情页.jpg)
  ↓ [阅读解析内容]
```

---

## 2. 技术架构决策

### 2.1 分层架构（推荐方案）

```
┌─────────────────────────────────────────────────┐
│ Layer 3: React DOM + GSAP (前景层)               │
│ - 所有 UI 组件                                   │
│ - 页面路由与交互逻辑                             │
│ - GSAP 驱动的 UI 动画                            │
├─────────────────────────────────────────────────┤
│ Layer 2: CSS + Canvas 2D (中景层) - 基础方案     │
│ - 毛玻璃效果                                     │
│ - 渐变背景                                       │
│ - Canvas 2D 粒子系统 (200-500个)                 │
├─────────────────────────────────────────────────┤
│ Layer 1: Three.js WebGL (背景层) - 可选增强      │
│ - 云雾流动效果 (Shader)                          │
│ - 高级粒子系统 (3000-5000个)                     │
│ - 交互式光效                                     │
└─────────────────────────────────────────────────┘
```

### 2.2 技术栈确认

| 技术 | 用途 | 必选/可选 |
|------|------|----------|
| **React 18+** | UI 框架 | ✅ 必选 |
| **Vite** | 构建工具 | ✅ 必选 |
| **GSAP 3.x** | UI 动画引擎 | ✅ 必选 |
| **CSS Module** | 样式隔离 | ✅ 必选 |
| **Canvas 2D** | 基础粒子背景 | ✅ 必选 |
| **Three.js** | 高级3D背景 | ⭐ 可选增强 |
| **Electron** | 桌面打包 | ✅ 必选 |

### 2.3 推荐项目结构

```
dreambook/
├── src/
│   ├── components/
│   │   ├── Background/
│   │   │   ├── GradientBackground.tsx    # CSS 渐变背景
│   │   │   ├── ParticleCanvas.tsx        # Canvas 2D 粒子
│   │   │   └── ThreeBackground.tsx       # Three.js 背景（可选）
│   │   ├── Card/
│   │   │   ├── DreamCard.tsx             # 梦境卡片组件
│   │   │   └── GlassCard.tsx             # 毛玻璃卡片
│   │   ├── Navigation/
│   │   │   └── HomeButton.tsx            # 返回主页按钮
│   │   └── Settings/
│   │       └── PerformanceToggle.tsx     # 性能模式切换
│   ├── pages/
│   │   ├── HomePage.tsx                   # 首页
│   │   ├── NavigationPage.tsx             # 导航/搜索页
│   │   └── DetailPage.tsx                 # 详情页
│   ├── animations/
│   │   ├── pageTransitions.ts             # 页面转场动画
│   │   ├── cardAnimations.ts              # 卡片动画
│   │   └── emotionMappings.ts             # 情绪动画映射
│   ├── utils/
│   │   ├── performanceMonitor.ts          # 性能监控
│   │   └── emotionConfig.ts               # 情绪配置数据
│   ├── data/
│   │   └── dreamData.json                 # 10个梦境数据
│   ├── styles/
│   │   ├── variables.css                  # CSS 变量
│   │   └── global.css                     # 全局样式
│   └── App.tsx
├── electron/
│   ├── main.js                            # Electron 主进程
│   └── preload.js                         # 预加载脚本
├── public/
│   └── assets/                            # 图片资源
└── package.json
```

---

## 3. 性能优化策略

### 3.1 Three.js 可选方案（渐进增强）

#### **方案核心：双模式架构**

```javascript
// 性能模式配置
const PERFORMANCE_MODES = {
  HIGH: {
    name: '高品质模式',
    useThreeJS: true,
    particleCount: 5000,
    shaderQuality: 'high'
  },
  STANDARD: {
    name: '标准模式',
    useThreeJS: false,
    particleCount: 300,
    canvas2D: true
  },
  ECO: {
    name: '省电模式',
    useThreeJS: false,
    particleCount: 0,
    cssOnly: true
  }
}
```

#### **模式切换时机**

| 触发条件 | 动作 | 切换时间 |
|---------|------|---------|
| **启动检测** | GPU型号检测 → 选择默认模式 | 3秒内完成 |
| **性能监控** | FPS < 45fps 持续1分钟 → 降级 | 0.8-1.0秒过渡 |
| **手动切换** | 用户在设置中切换 | 1.0秒淡入淡出 |
| **空闲模式** | 3分钟无操作 → 降速20-30% | 即时生效 |

### 3.2 性能监控指标

```javascript
// 需要实时监控的指标
const PERFORMANCE_METRICS = {
  targetFPS: 60,
  minFPS: 50,           // 低于此值触发降级
  maxMemory: 500,       // MB，超过触发GC
  checkInterval: 5000   // 每5秒检查一次
}
```

### 3.3 内存管理规则

#### **Three.js 资源释放（关键！）**

```javascript
// 关闭 Three.js 时必须执行：
✅ scene.clear()           // 清空场景
✅ renderer.dispose()      // 释放渲染器
✅ geometry.dispose()      // 释放几何体
✅ material.dispose()      // 释放材质
✅ texture.dispose()       // 释放纹理
✅ renderer.forceContextLoss() // 强制释放WebGL Context
```

### 3.4 长时间运行优化

| 时间点 | 策略 |
|-------|------|
| **启动时** | 预加载所有资源，避免运行时加载 |
| **运行2小时后** | 执行一次垃圾回收 |
| **运行6小时后** | 降低粒子数量20% |
| **空闲3分钟** | 进入省电模式 |
| **每日22:00** | 建议自动重启应用 |

---

## 4. 动效设计规范

### 4.1 三层动画结构

| 层级 | 负责内容 | 动画特性 |
|-----|---------|---------|
| **背景层** | 空间感、光雾、粒子 | 极慢、连续、周期 ≥ 60秒 |
| **中景层** | 视觉焦点元素 | 轻微呼吸/漂浮 |
| **前景层** | UI交互元素 | 进场动画 + 交互反馈 |

### 4.2 动效时长规范

| 动画类型 | 推荐时长 | 缓动函数 |
|---------|---------|---------|
| **交互反馈** | 150-300ms | Power2.easeOut |
| **页面转场** | 400-800ms | Power3.easeInOut |
| **卡片进场** | 500-700ms | Expo.easeOut |
| **背景循环** | 60-120秒 | Linear / Sine.easeInOut |

### 4.3 首页动画清单

#### A. 背景层（基础方案：CSS + Canvas 2D）

```css
/* CSS 渐变背景 */
background: linear-gradient(135deg,
  #8B5CF6 0%,    /* 紫色 */
  #6366F1 35%,   /* 靛蓝 */
  #3B82F6 70%,   /* 蓝色 */
  #2563EB 100%   /* 深蓝 */
);

/* 缓慢旋转动画（180秒一周期） */
animation: gradientRotate 180s ease-in-out infinite;
```

**Canvas 2D 粒子参数：**
- 粒子数量：200-300个
- 粒子大小：2-4px（带模糊）
- 运动速度：每秒1-3px
- 运动方向：轻微向上漂浮
- 透明度：0.3-0.6

#### B. 中景层（可选：Three.js 光球）

**如果启用 Three.js：**
- 位置：画面中心偏上10%
- 大小：直径约300px
- 浮动幅度：垂直 ±12px
- 浮动周期：8秒
- 表面效果：轻微噪声扰动

**如果不启用：**
- 用 CSS 实现发光圆形
- backdrop-filter: blur(40px)
- box-shadow: 0 0 100px rgba(139, 92, 246, 0.6)

#### C. 前景层（UI 动画）

**页面进入动画（GSAP Timeline）：**

```javascript
const timeline = gsap.timeline();

timeline
  .from('.logo', {
    y: -30,
    opacity: 0,
    duration: 0.8,
    ease: 'power3.out'
  })
  .from('.main-title', {
    y: 20,
    opacity: 0,
    duration: 0.6,
    ease: 'power2.out'
  }, '-=0.3')
  .from('.subtitle', {
    y: 20,
    opacity: 0,
    duration: 0.6,
    ease: 'power2.out'
  }, '-=0.4')
  .from('.cta-button', {
    scale: 0.9,
    opacity: 0,
    duration: 0.5,
    ease: 'back.out(1.4)'
  }, '-=0.3');
```

**静态呼吸动画：**
- 主卡片 scale: 1.00 → 1.02 → 1.00
- 周期：8秒
- 缓动：sine.inOut

**按钮交互：**
- 按下：scale 0.95 → 1.02 → 1.00
- 时长：200ms
- 辉光增强：box-shadow 放大 120%

### 4.4 导航页动画清单

#### A. 卡片网格进场动画

```javascript
gsap.from('.dream-card', {
  y: 30,
  opacity: 0,
  duration: 0.6,
  stagger: 0.08,  // 每个卡片延迟 80ms
  ease: 'power2.out'
});
```

#### B. 卡片悬停效果

```css
.dream-card:hover {
  transform: translateY(-4px) scale(1.02);
  box-shadow: 0 12px 40px rgba(139, 92, 246, 0.4);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
```

#### C. 情绪背景切换

| 情绪类型 | 背景色调 | 粒子行为 | 过渡时长 |
|---------|---------|---------|---------|
| **快乐 Joy** | 暖黄+橙 (#FFA500 → #FFD700) | 向上漂，速度 +30% | 1.0秒 |
| **悲伤 Sad** | 冷蓝+紫 (#4C1D95 → #1E3A8A) | 向下沉，速度 -50% | 1.2秒 |
| **恐惧 Fear** | 深蓝+暗紫 (#1E1B4B → #312E81) | 轻微抖动 | 0.8秒 |
| **平静 Calm** | 蓝绿 (#0EA5E9 → #06B6D4) | 几乎静止 | 1.5秒 |

### 4.5 详情页动画清单

#### A. 页面进入动画

```javascript
const detailTimeline = gsap.timeline();

detailTimeline
  .from('.detail-title', {
    y: -20,
    opacity: 0,
    duration: 0.5
  })
  .from('.detail-image', {
    scale: 0.96,
    opacity: 0,
    duration: 0.6
  }, '-=0.3')
  .from('.detail-paragraph', {
    y: 15,
    opacity: 0,
    duration: 0.4,
    stagger: 0.08
  }, '-=0.3');
```

#### B. 背景超安静模式

- 对比度降低 30%
- 移动周期延长到 120-180秒
- 粒子数量减少到 20-30个
- 运动速度降至 0.5-1px/秒

---

## 5. Three.js 可选方案

### 5.1 实施决策树

```
是否使用 Three.js？
│
├─ 能提前测试真实硬件？
│  ├─ 能 → 先实现 Canvas 2D，测试后决定是否升级
│  └─ 不能 → 使用 Canvas 2D 保守方案
│
├─ 设备会连续运行 > 6小时？
│  ├─ 会 → Three.js 需添加降级机制
│  └─ 不会 → Three.js 可以放心使用
│
└─ 星空背景是核心体验？
   ├─ 是 → 值得用 Three.js（配合性能监控）
   └─ 不是 → Canvas 2D 完全够用
```

### 5.2 Three.js 性能参数

| 参数 | 高性能模式 | 标准模式 | 降级模式 |
|-----|-----------|---------|---------|
| **粒子数量** | 5000 | 3000 | 1500 |
| **渲染分辨率** | 1920×1080 | 1600×900 | 1280×720 |
| **Shader 质量** | High | Medium | Low |
| **后处理效果** | Bloom | 无 | 无 |
| **阴影** | 关闭 | 关闭 | 关闭 |

### 5.3 切换逻辑伪代码

```javascript
// 启动时性能检测
async function initBackground() {
  const gpuInfo = await detectGPU();
  const mode = determineMode(gpuInfo);

  if (mode === 'HIGH' && user.preference !== 'disabled') {
    startThreeJSBackground();
  } else {
    startCanvas2DBackground();
  }

  startPerformanceMonitoring();
}

// 运行时监控
function monitorPerformance() {
  setInterval(() => {
    const fps = getFPS();
    const memory = getMemoryUsage();

    if (fps < 45 && currentMode === 'THREE_JS') {
      switchToCanvas2D(); // 自动降级
    }

    if (memory > 500) {
      triggerGarbageCollection();
    }
  }, 5000);
}

// 平滑切换
async function switchToCanvas2D() {
  await fadeOut(threeCanvas, 500);
  disposeThreeJS();
  await fadeIn(canvas2D, 500);

  showNotification('已切换到标准模式以优化性能');
}
```

---

## 6. 开发优先级

### Phase 1：基础框架（2-3天）

- [ ] 搭建 React + Vite 项目
- [ ] 配置 TypeScript
- [ ] 安装 GSAP、React Router
- [ ] 设计组件结构
- [ ] 准备静态资源（导出设计稿中的图片）

### Phase 2：基础视觉（3-4天）

- [ ] CSS 渐变背景系统
- [ ] Canvas 2D 粒子系统
- [ ] 毛玻璃卡片组件
- [ ] 基础布局（首页/导航/详情）
- [ ] 字体加载与排版

### Phase 3：核心动画（2-3天）

- [ ] GSAP 页面进场动画
- [ ] 页面转场动画
- [ ] 卡片交互动画
- [ ] 情绪背景切换逻辑
- [ ] 粒子系统与情绪联动

### Phase 4：数据集成（1-2天）

- [ ] 创建梦境数据结构
- [ ] 情绪配置映射表
- [ ] 搜索功能
- [ ] 内容渲染逻辑

### Phase 5：Three.js 增强（可选，2-3天）

- [ ] Three.js 场景搭建
- [ ] 云雾 Shader 开发
- [ ] 粒子系统升级
- [ ] 性能检测逻辑
- [ ] 双模式切换实现

### Phase 6：触摸优化（1-2天）

- [ ] 触摸事件适配
- [ ] 按钮点击区域放大（最小 48×48px）
- [ ] 滑动手势支持
- [ ] 长按返回主页
- [ ] 防误触优化

### Phase 7：Electron 打包（1-2天）

- [ ] Electron 配置
- [ ] 全屏模式
- [ ] 隐藏菜单栏
- [ ] 触摸屏驱动测试
- [ ] 打包优化（资源压缩）

### Phase 8：性能优化（2-3天）

- [ ] 性能监控系统
- [ ] 自动降级逻辑
- [ ] 内存泄漏检测
- [ ] 空闲模式实现
- [ ] 图片懒加载

### Phase 9：真机测试（3-5天）

- [ ] 在实际触摸屏上测试
- [ ] 长时间运行测试（8小时+）
- [ ] 性能数据收集
- [ ] 用户体验测试
- [ ] Bug 修复

---

## 7. 测试验收标准

### 7.1 性能指标

| 指标 | 标准值 | 测试方法 |
|-----|--------|---------|
| **启动时间** | < 3秒 | 从点击到首页完全显示 |
| **页面切换** | < 0.8秒 | 转场动画完成时间 |
| **帧率** | ≥ 55fps | Chrome DevTools Performance |
| **内存占用** | < 400MB | 运行2小时后检测 |
| **CPU占用** | < 15% | 空闲状态平均值 |
| **GPU占用** | < 30% | 使用 GPU-Z 监控 |

### 7.2 功能清单

#### 首页
- [ ] 背景渐变正常显示
- [ ] 粒子动画流畅
- [ ] Logo 和标题进场动画正确
- [ ] 按钮点击有反馈
- [ ] 点击按钮正确跳转

#### 导航页
- [ ] 10个梦境卡片正确显示
- [ ] 卡片悬停效果正常
- [ ] 搜索功能可用
- [ ] 情绪切换时背景平滑过渡
- [ ] 点击卡片正确进入详情

#### 详情页
- [ ] 内容完整显示
- [ ] 文字清晰可读
- [ ] 背景不干扰阅读
- [ ] 返回按钮可用
- [ ] 滚动流畅

### 7.3 触摸屏专项测试

- [ ] 所有按钮点击区域 ≥ 48×48px
- [ ] 单指点击响应正常
- [ ] 双指缩放已禁用
- [ ] 滑动流畅无卡顿
- [ ] 长按（1秒）返回主页
- [ ] 3分钟无操作自动返回首页

### 7.4 长时间运行测试

| 时间点 | 检查项 |
|-------|-------|
| **启动后1小时** | 检查内存是否稳定 |
| **运行4小时** | 检查是否掉帧 |
| **运行8小时** | 检查是否卡死/崩溃 |
| **运行12小时** | 检查设备温度 |

### 7.5 视觉还原度

- [ ] 背景渐变颜色与设计稿一致
- [ ] 毛玻璃效果正确（模糊度 10-20px）
- [ ] 字体大小与设计稿误差 < 2px
- [ ] 卡片间距与设计稿一致
- [ ] 动画节奏符合"缓慢、柔和"要求

---

## 附录

### A. 性能模式对比表

| 特性 | 高品质模式 | 标准模式 | 省电模式 |
|-----|-----------|---------|---------|
| **Three.js** | ✅ 启用 | ❌ 禁用 | ❌ 禁用 |
| **Canvas 2D** | ❌ | ✅ 300粒子 | ❌ |
| **CSS 动画** | ✅ 全部 | ✅ 全部 | ✅ 仅必要 |
| **粒子数量** | 5000 | 300 | 0 |
| **内存占用** | ~280MB | ~120MB | ~80MB |
| **GPU占用** | 25% | 8% | 3% |
| **适用设备** | 独显/高端集显 | 标准集显 | 低端设备 |

### B. 情绪配置完整映射表

```javascript
const EMOTION_CONFIGS = {
  JOY: {
    background: 'linear-gradient(135deg, #FFA500, #FFD700, #FDB813)',
    particleColor: '#FFE066',
    particleSpeed: 1.3,
    particleDirection: 'up',
    fogSpeed: 1.2
  },
  SAD: {
    background: 'linear-gradient(135deg, #4C1D95, #5B21B6, #1E3A8A)',
    particleColor: '#818CF8',
    particleSpeed: 0.5,
    particleDirection: 'down',
    fogSpeed: 0.7
  },
  FEAR: {
    background: 'linear-gradient(135deg, #1E1B4B, #312E81, #1F2937)',
    particleColor: '#6366F1',
    particleSpeed: 0.8,
    particleDirection: 'random',
    fogSpeed: 0.9
  },
  CALM: {
    background: 'linear-gradient(135deg, #0EA5E9, #06B6D4, #0891B2)',
    particleColor: '#7DD3FC',
    particleSpeed: 0.3,
    particleDirection: 'static',
    fogSpeed: 0.5
  },
  STRESS: {
    background: 'linear-gradient(135deg, #7C2D12, #1E3A8A, #374151)',
    particleColor: '#94A3B8',
    particleSpeed: 1.0,
    particleDirection: 'spiral',
    fogSpeed: 1.1
  }
}
```

### C. 关键资源清单

#### 必需图片资源
- Logo（SVG 格式，支持缩放）
- 10个梦境配图（WebP 格式，1200×800px）
- 图标（返回、搜索、设置等）

#### 字体资源
- 主标题字体：思源黑体 / Noto Sans SC（Bold）
- 正文字体：思源黑体 / Noto Sans SC（Regular）
- 英文副标题：Poppins / Inter（Medium）

#### 音效资源（可选）
- 页面切换：轻柔"嗖"声（100ms）
- 按钮点击：轻快"嗒"声（50ms）
- 背景环境音：白噪音/轻音乐（循环播放，音量极低）

---

## 文档更新记录

| 版本 | 日期 | 更新内容 | 作者 |
|-----|------|---------|------|
| v1.0 | 2025-11-30 | 初始版本，完整规范 | Claude |

---

**本文档参考资料：**
- 设计稿：`首页.jpg`、`导航.jpg`、`详情页.jpg`
- 动画规则：`动画规则1.md`
- 技术讨论记录：2025-11-30

**下一步行动：**
1. 评审本文档，确认技术方案
2. 决定是否启用 Three.js
3. 开始 Phase 1 开发
