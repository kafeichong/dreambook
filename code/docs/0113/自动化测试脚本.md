# DreamBook Kiosk è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

> è‡ªåŠ¨åŒ–åŠŸèƒ½æµ‹è¯•ã€éªŒè¯å’Œç›‘æ§è„šæœ¬é›†åˆ

---

## ğŸ“‹ è„šæœ¬æ¸…å•

| è„šæœ¬ | ç”¨é€” | è¯­è¨€ | è‡ªåŠ¨åŒ–ç¨‹åº¦ |
|------|------|------|-----------|
| test-all.ps1 | å®Œæ•´æµ‹è¯•å¥—ä»¶ | PowerShell | âœ… å…¨è‡ªåŠ¨ |
| test-startup.ps1 | å¯åŠ¨æµ‹è¯• | PowerShell | âœ… å…¨è‡ªåŠ¨ |
| test-virtual-keyboard.ps1 | è™šæ‹Ÿé”®ç›˜æµ‹è¯• | PowerShell | âš ï¸ åŠè‡ªåŠ¨ |
| test-backend.ps1 | åç«¯æœåŠ¡æµ‹è¯• | PowerShell | âœ… å…¨è‡ªåŠ¨ |
| test-performance.ps1 | æ€§èƒ½æµ‹è¯• | PowerShell | âœ… å…¨è‡ªåŠ¨ |
| monitor-health.ps1 | å¥åº·ç›‘æ§ | PowerShell | âœ… å…¨è‡ªåŠ¨ |

---

## ğŸš€ å®Œæ•´æµ‹è¯•å¥—ä»¶

**æ–‡ä»¶:** `test-all.ps1`

```powershell
# DreamBook Kiosk å®Œæ•´è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶
# ç‰ˆæœ¬: 1.0
# æ—¥æœŸ: 2026-01-13

param(
    [switch]$Verbose = $false,
    [switch]$GenerateReport = $true
)

# é¢œè‰²è¾“å‡ºå‡½æ•°
function Write-TestHeader {
    param([string]$Text)
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host "  $Text" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host ""
}

function Write-TestResult {
    param(
        [string]$TestName,
        [bool]$Passed,
        [string]$Details = ""
    )
    $Status = if ($Passed) { "[é€šè¿‡]" } else { "[å¤±è´¥]" }
    $Color = if ($Passed) { "Green" } else { "Red" }

    Write-Host "$Status $TestName" -ForegroundColor $Color
    if ($Details -and $Verbose) {
        Write-Host "       $Details" -ForegroundColor Gray
    }

    return @{
        TestName = $TestName
        Passed = $Passed
        Details = $Details
        Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    }
}

# æµ‹è¯•ç»“æœå­˜å‚¨
$TestResults = @()
$StartTime = Get-Date

Write-TestHeader "DreamBook Kiosk è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶ v1.0"

# ========================================
# æµ‹è¯• 1: ç³»ç»Ÿé…ç½®éªŒè¯
# ========================================
Write-TestHeader "æµ‹è¯• 1: ç³»ç»Ÿé…ç½®éªŒè¯"

# 1.1 æ£€æŸ¥ kiosk ç”¨æˆ·
try {
    $User = net user kiosk 2>&1
    $Passed = $LASTEXITCODE -eq 0
    $TestResults += Write-TestResult "kiosk ç”¨æˆ·å­˜åœ¨" $Passed
} catch {
    $TestResults += Write-TestResult "kiosk ç”¨æˆ·å­˜åœ¨" $false "å¼‚å¸¸: $_"
}

# 1.2 æ£€æŸ¥è‡ªåŠ¨ç™»å½•é…ç½®
try {
    $AutoLogon = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name "AutoAdminLogon" -ErrorAction SilentlyContinue).AutoAdminLogon
    $Passed = $AutoLogon -eq "1"
    $TestResults += Write-TestResult "è‡ªåŠ¨ç™»å½•å·²å¯ç”¨" $Passed "AutoAdminLogon=$AutoLogon"
} catch {
    $TestResults += Write-TestResult "è‡ªåŠ¨ç™»å½•å·²å¯ç”¨" $false "å¼‚å¸¸: $_"
}

# 1.3 æ£€æŸ¥é»˜è®¤ç”¨æˆ·å
try {
    $DefaultUser = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -Name "DefaultUserName" -ErrorAction SilentlyContinue).DefaultUserName
    $Passed = $DefaultUser -eq "kiosk"
    $TestResults += Write-TestResult "é»˜è®¤ç”¨æˆ·åé…ç½®æ­£ç¡®" $Passed "DefaultUserName=$DefaultUser"
} catch {
    $TestResults += Write-TestResult "é»˜è®¤ç”¨æˆ·åé…ç½®æ­£ç¡®" $false "å¼‚å¸¸: $_"
}

# 1.4 æ£€æŸ¥ TabletInputService
try {
    $Service = Get-Service -Name TabletInputService -ErrorAction SilentlyContinue
    $Passed = $Service.Status -eq "Running"
    $TestResults += Write-TestResult "è™šæ‹Ÿé”®ç›˜æœåŠ¡è¿è¡Œä¸­" $Passed "çŠ¶æ€: $($Service.Status)"
} catch {
    $TestResults += Write-TestResult "è™šæ‹Ÿé”®ç›˜æœåŠ¡è¿è¡Œä¸­" $false "å¼‚å¸¸: $_"
}

# ========================================
# æµ‹è¯• 2: åº”ç”¨æ–‡ä»¶éªŒè¯
# ========================================
Write-TestHeader "æµ‹è¯• 2: åº”ç”¨æ–‡ä»¶éªŒè¯"

# 2.1 æ£€æŸ¥åº”ç”¨æ–‡ä»¶
$AppPath = "C:\kiosk\dreambook\dreambook.exe"
try {
    $Passed = Test-Path $AppPath
    $FileSize = if ($Passed) { (Get-Item $AppPath).Length / 1MB } else { 0 }
    $TestResults += Write-TestResult "åº”ç”¨æ–‡ä»¶å­˜åœ¨" $Passed "å¤§å°: $([math]::Round($FileSize, 2)) MB"
} catch {
    $TestResults += Write-TestResult "åº”ç”¨æ–‡ä»¶å­˜åœ¨" $false "å¼‚å¸¸: $_"
}

# 2.2 æ£€æŸ¥æ–‡ä»¶æƒé™
try {
    $Acl = Get-Acl $AppPath -ErrorAction SilentlyContinue
    $KioskAccess = $Acl.Access | Where-Object { $_.IdentityReference -like "*kiosk*" }
    $Passed = $KioskAccess -ne $null
    $TestResults += Write-TestResult "kiosk ç”¨æˆ·æœ‰è®¿é—®æƒé™" $Passed
} catch {
    $TestResults += Write-TestResult "kiosk ç”¨æˆ·æœ‰è®¿é—®æƒé™" $false "å¼‚å¸¸: $_"
}

# ========================================
# æµ‹è¯• 3: åº”ç”¨è¿›ç¨‹éªŒè¯
# ========================================
Write-TestHeader "æµ‹è¯• 3: åº”ç”¨è¿›ç¨‹éªŒè¯"

# 3.1 æ£€æŸ¥åº”ç”¨è¿›ç¨‹
try {
    $Process = Get-Process -Name "dreambook" -ErrorAction SilentlyContinue
    $Passed = $Process -ne $null
    $Details = if ($Passed) { "PID: $($Process.Id), å†…å­˜: $([math]::Round($Process.WorkingSet64 / 1MB, 2)) MB" } else { "è¿›ç¨‹æœªè¿è¡Œ" }
    $TestResults += Write-TestResult "åº”ç”¨è¿›ç¨‹è¿è¡Œä¸­" $Passed $Details
} catch {
    $TestResults += Write-TestResult "åº”ç”¨è¿›ç¨‹è¿è¡Œä¸­" $false "å¼‚å¸¸: $_"
}

# 3.2 æ£€æŸ¥è¿›ç¨‹å“åº”
if ($Process) {
    try {
        $Passed = -not $Process.Responding -eq $false
        $TestResults += Write-TestResult "åº”ç”¨å“åº”æ­£å¸¸" $Passed
    } catch {
        $TestResults += Write-TestResult "åº”ç”¨å“åº”æ­£å¸¸" $false "å¼‚å¸¸: $_"
    }
}

# ========================================
# æµ‹è¯• 4: åç«¯æœåŠ¡éªŒè¯
# ========================================
Write-TestHeader "æµ‹è¯• 4: åç«¯æœåŠ¡éªŒè¯"

# 4.1 æ£€æŸ¥ç«¯å£ç›‘å¬
try {
    $Port3000 = Get-NetTCPConnection -LocalPort 3000 -State Listen -ErrorAction SilentlyContinue
    $Passed = $Port3000 -ne $null
    $TestResults += Write-TestResult "åç«¯ç«¯å£ 3000 ç›‘å¬ä¸­" $Passed
} catch {
    $TestResults += Write-TestResult "åç«¯ç«¯å£ 3000 ç›‘å¬ä¸­" $false "å¼‚å¸¸: $_"
}

# 4.2 æµ‹è¯•åç«¯ API
try {
    $Response = Invoke-WebRequest -Uri "http://localhost:3000/api/health" -UseBasicParsing -TimeoutSec 5 -ErrorAction SilentlyContinue
    $Passed = $Response.StatusCode -eq 200
    $TestResults += Write-TestResult "åç«¯ API å“åº”æ­£å¸¸" $Passed "çŠ¶æ€ç : $($Response.StatusCode)"
} catch {
    $TestResults += Write-TestResult "åç«¯ API å“åº”æ­£å¸¸" $false "å¼‚å¸¸: $_"
}

# ========================================
# æµ‹è¯• 5: æ€§èƒ½æŒ‡æ ‡éªŒè¯
# ========================================
Write-TestHeader "æµ‹è¯• 5: æ€§èƒ½æŒ‡æ ‡éªŒè¯"

if ($Process) {
    # 5.1 CPU ä½¿ç”¨ç‡
    try {
        $CPU = ($Process | Get-Counter "\Process($($Process.Name))\% Processor Time" -ErrorAction SilentlyContinue).CounterSamples.CookedValue
        $Passed = $CPU -lt 20
        $TestResults += Write-TestResult "CPU ä½¿ç”¨ç‡æ­£å¸¸ (<20%)" $Passed "å½“å‰: $([math]::Round($CPU, 2))%"
    } catch {
        $TestResults += Write-TestResult "CPU ä½¿ç”¨ç‡æ­£å¸¸ (<20%)" $false "å¼‚å¸¸: $_"
    }

    # 5.2 å†…å­˜ä½¿ç”¨
    try {
        $MemoryMB = $Process.WorkingSet64 / 1MB
        $Passed = $MemoryMB -lt 500
        $TestResults += Write-TestResult "å†…å­˜ä½¿ç”¨æ­£å¸¸ (<500MB)" $Passed "å½“å‰: $([math]::Round($MemoryMB, 2)) MB"
    } catch {
        $TestResults += Write-TestResult "å†…å­˜ä½¿ç”¨æ­£å¸¸ (<500MB)" $false "å¼‚å¸¸: $_"
    }
}

# ========================================
# æµ‹è¯• 6: æ—¥å¿—æ–‡ä»¶éªŒè¯
# ========================================
Write-TestHeader "æµ‹è¯• 6: æ—¥å¿—æ–‡ä»¶éªŒè¯"

# 6.1 æ£€æŸ¥æ—¥å¿—ç›®å½•
$LogDir = "$env:USERPROFILE\dreambook-logs"
try {
    $Passed = Test-Path $LogDir
    $TestResults += Write-TestResult "æ—¥å¿—ç›®å½•å­˜åœ¨" $Passed
} catch {
    $TestResults += Write-TestResult "æ—¥å¿—ç›®å½•å­˜åœ¨" $false "å¼‚å¸¸: $_"
}

# 6.2 æ£€æŸ¥ä»Šæ—¥æ—¥å¿—
try {
    $Today = Get-Date -Format "yyyy-MM-dd"
    $TodayLog = "$LogDir\app-$Today.log"
    $Passed = Test-Path $TodayLog
    $Details = if ($Passed) { "å¤§å°: $([math]::Round((Get-Item $TodayLog).Length / 1KB, 2)) KB" } else { "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨" }
    $TestResults += Write-TestResult "ä»Šæ—¥æ—¥å¿—æ–‡ä»¶å­˜åœ¨" $Passed $Details
} catch {
    $TestResults += Write-TestResult "ä»Šæ—¥æ—¥å¿—æ–‡ä»¶å­˜åœ¨" $false "å¼‚å¸¸: $_"
}

# 6.3 æ£€æŸ¥é”™è¯¯æ—¥å¿—
if (Test-Path $TodayLog) {
    try {
        $Errors = Select-String -Path $TodayLog -Pattern "\[é”™è¯¯\]|\[å¼‚å¸¸\]|error|exception" -SimpleMatch
        $Passed = $Errors.Count -eq 0
        $Details = if ($Passed) { "æ— é”™è¯¯" } else { "å‘ç° $($Errors.Count) ä¸ªé”™è¯¯" }
        $TestResults += Write-TestResult "æ—¥å¿—ä¸­æ— ä¸¥é‡é”™è¯¯" $Passed $Details
    } catch {
        $TestResults += Write-TestResult "æ—¥å¿—ä¸­æ— ä¸¥é‡é”™è¯¯" $false "å¼‚å¸¸: $_"
    }
}

# ========================================
# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
# ========================================
$EndTime = Get-Date
$Duration = ($EndTime - $StartTime).TotalSeconds

Write-TestHeader "æµ‹è¯•ç»“æœæ±‡æ€»"

$PassedCount = ($TestResults | Where-Object { $_.Passed }).Count
$FailedCount = ($TestResults | Where-Object { -not $_.Passed }).Count
$TotalCount = $TestResults.Count
$PassRate = if ($TotalCount -gt 0) { ($PassedCount / $TotalCount) * 100 } else { 0 }

Write-Host "æ€»æµ‹è¯•æ•°: $TotalCount" -ForegroundColor White
Write-Host "é€šè¿‡: $PassedCount" -ForegroundColor Green
Write-Host "å¤±è´¥: $FailedCount" -ForegroundColor Red
Write-Host "é€šè¿‡ç‡: $([math]::Round($PassRate, 2))%" -ForegroundColor $(if ($PassRate -ge 80) { "Green" } else { "Red" })
Write-Host "æ€»è€—æ—¶: $([math]::Round($Duration, 2)) ç§’" -ForegroundColor White
Write-Host ""

# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
if ($GenerateReport) {
    $ReportPath = "C:\kiosk\backups\test-reports\test-$(Get-Date -Format 'yyyyMMdd-HHmmss').html"
    $ReportDir = Split-Path $ReportPath -Parent

    if (-not (Test-Path $ReportDir)) {
        New-Item -ItemType Directory -Path $ReportDir -Force | Out-Null
    }

    $HtmlReport = @"
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>DreamBook Kiosk æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .summary { display: flex; justify-content: space-around; margin: 30px 0; }
        .metric { text-align: center; padding: 20px; background: #ecf0f1; border-radius: 8px; min-width: 150px; }
        .metric-value { font-size: 36px; font-weight: bold; }
        .metric-label { color: #7f8c8d; margin-top: 5px; }
        .passed { color: #27ae60; }
        .failed { color: #e74c3c; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #34495e; color: white; }
        tr:hover { background: #f8f9fa; }
        .status-passed { color: #27ae60; font-weight: bold; }
        .status-failed { color: #e74c3c; font-weight: bold; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #7f8c8d; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DreamBook Kiosk æµ‹è¯•æŠ¥å‘Š</h1>
        <div class="summary">
            <div class="metric">
                <div class="metric-value">$TotalCount</div>
                <div class="metric-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="metric">
                <div class="metric-value passed">$PassedCount</div>
                <div class="metric-label">é€šè¿‡</div>
            </div>
            <div class="metric">
                <div class="metric-value failed">$FailedCount</div>
                <div class="metric-label">å¤±è´¥</div>
            </div>
            <div class="metric">
                <div class="metric-value">$([math]::Round($PassRate, 1))%</div>
                <div class="metric-label">é€šè¿‡ç‡</div>
            </div>
        </div>

        <h2>æµ‹è¯•è¯¦æƒ…</h2>
        <table>
            <thead>
                <tr>
                    <th>æµ‹è¯•åç§°</th>
                    <th>çŠ¶æ€</th>
                    <th>è¯¦ç»†ä¿¡æ¯</th>
                    <th>æ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
"@

    foreach ($Result in $TestResults) {
        $StatusClass = if ($Result.Passed) { "status-passed" } else { "status-failed" }
        $StatusText = if ($Result.Passed) { "é€šè¿‡" } else { "å¤±è´¥" }

        $HtmlReport += @"
                <tr>
                    <td>$($Result.TestName)</td>
                    <td class="$StatusClass">$StatusText</td>
                    <td>$($Result.Details)</td>
                    <td>$($Result.Timestamp)</td>
                </tr>
"@
    }

    $HtmlReport += @"
            </tbody>
        </table>

        <div class="footer">
            <p>æµ‹è¯•å¼€å§‹æ—¶é—´: $($StartTime.ToString("yyyy-MM-dd HH:mm:ss"))</p>
            <p>æµ‹è¯•ç»“æŸæ—¶é—´: $($EndTime.ToString("yyyy-MM-dd HH:mm:ss"))</p>
            <p>æ€»è€—æ—¶: $([math]::Round($Duration, 2)) ç§’</p>
            <p>ç”Ÿæˆæ—¶é—´: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
        </div>
    </div>
</body>
</html>
"@

    $HtmlReport | Out-File -FilePath $ReportPath -Encoding UTF8
    Write-Host "[æŠ¥å‘Š] æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $ReportPath" -ForegroundColor Cyan
}

# è¿”å›é€€å‡ºç 
if ($FailedCount -eq 0) {
    exit 0
} else {
    exit 1
}
```

---

## ğŸ” åç«¯æœåŠ¡æµ‹è¯•è„šæœ¬

**æ–‡ä»¶:** `test-backend.ps1`

```powershell
# DreamBook åç«¯æœåŠ¡è‡ªåŠ¨åŒ–æµ‹è¯•
# æµ‹è¯• API ç«¯ç‚¹å’Œ DeepSeek é›†æˆ

param(
    [string]$BaseUrl = "http://localhost:3000",
    [int]$Timeout = 10
)

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  DreamBook åç«¯æœåŠ¡æµ‹è¯•" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

$TestResults = @()

# æµ‹è¯• 1: Health Check
Write-Host "[æµ‹è¯• 1] Health Check ç«¯ç‚¹" -ForegroundColor Yellow
try {
    $Response = Invoke-WebRequest -Uri "$BaseUrl/api/health" -Method GET -UseBasicParsing -TimeoutSec $Timeout
    if ($Response.StatusCode -eq 200) {
        Write-Host "[é€šè¿‡] Health Check æ­£å¸¸" -ForegroundColor Green
        $TestResults += @{ Test = "Health Check"; Status = "Pass" }
    } else {
        Write-Host "[å¤±è´¥] Health Check è¿”å›é 200 çŠ¶æ€ç : $($Response.StatusCode)" -ForegroundColor Red
        $TestResults += @{ Test = "Health Check"; Status = "Fail" }
    }
} catch {
    Write-Host "[å¤±è´¥] Health Check è¯·æ±‚å¤±è´¥: $_" -ForegroundColor Red
    $TestResults += @{ Test = "Health Check"; Status = "Fail" }
}

# æµ‹è¯• 2: Dream Chat API
Write-Host "`n[æµ‹è¯• 2] Dream Chat API" -ForegroundColor Yellow
try {
    $Body = @{
        question = "æˆ‘æ¢¦è§è‡ªå·±åœ¨é£ç¿”ï¼Œè¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ"
    } | ConvertTo-Json

    $Response = Invoke-WebRequest -Uri "$BaseUrl/api/dream-chat" -Method POST -Body $Body -ContentType "application/json" -UseBasicParsing -TimeoutSec 30

    if ($Response.StatusCode -eq 200) {
        $Content = $Response.Content | ConvertFrom-Json
        if ($Content.answer) {
            Write-Host "[é€šè¿‡] Dream Chat API æ­£å¸¸" -ForegroundColor Green
            Write-Host "       AI å›å¤é•¿åº¦: $($Content.answer.Length) å­—ç¬¦" -ForegroundColor Gray
            $TestResults += @{ Test = "Dream Chat API"; Status = "Pass" }
        } else {
            Write-Host "[å¤±è´¥] Dream Chat API è¿”å›ç©ºç­”æ¡ˆ" -ForegroundColor Red
            $TestResults += @{ Test = "Dream Chat API"; Status = "Fail" }
        }
    } else {
        Write-Host "[å¤±è´¥] Dream Chat API è¿”å›é 200 çŠ¶æ€ç : $($Response.StatusCode)" -ForegroundColor Red
        $TestResults += @{ Test = "Dream Chat API"; Status = "Fail" }
    }
} catch {
    Write-Host "[å¤±è´¥] Dream Chat API è¯·æ±‚å¤±è´¥: $_" -ForegroundColor Red
    $TestResults += @{ Test = "Dream Chat API"; Status = "Fail" }
}

# æµ‹è¯• 3: é”™è¯¯å¤„ç†
Write-Host "`n[æµ‹è¯• 3] é”™è¯¯å¤„ç†" -ForegroundColor Yellow
try {
    $Body = @{
        question = ""  # ç©ºé—®é¢˜
    } | ConvertTo-Json

    $Response = Invoke-WebRequest -Uri "$BaseUrl/api/dream-chat" -Method POST -Body $Body -ContentType "application/json" -UseBasicParsing -TimeoutSec $Timeout -ErrorAction SilentlyContinue

    if ($Response.StatusCode -eq 400) {
        Write-Host "[é€šè¿‡] ç©ºé—®é¢˜è¿”å› 400 é”™è¯¯" -ForegroundColor Green
        $TestResults += @{ Test = "Error Handling"; Status = "Pass" }
    } else {
        Write-Host "[å¤±è´¥] ç©ºé—®é¢˜æœªè¿”å› 400 é”™è¯¯" -ForegroundColor Red
        $TestResults += @{ Test = "Error Handling"; Status = "Fail" }
    }
} catch {
    if ($_.Exception.Response.StatusCode -eq 400) {
        Write-Host "[é€šè¿‡] ç©ºé—®é¢˜è¿”å› 400 é”™è¯¯" -ForegroundColor Green
        $TestResults += @{ Test = "Error Handling"; Status = "Pass" }
    } else {
        Write-Host "[å¤±è´¥] é”™è¯¯å¤„ç†å¼‚å¸¸: $_" -ForegroundColor Red
        $TestResults += @{ Test = "Error Handling"; Status = "Fail" }
    }
}

# æ±‡æ€»ç»“æœ
Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  æµ‹è¯•ç»“æœæ±‡æ€»" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

$PassedCount = ($TestResults | Where-Object { $_.Status -eq "Pass" }).Count
$FailedCount = ($TestResults | Where-Object { $_.Status -eq "Fail" }).Count

Write-Host "é€šè¿‡: $PassedCount" -ForegroundColor Green
Write-Host "å¤±è´¥: $FailedCount" -ForegroundColor Red

if ($FailedCount -eq 0) {
    Write-Host "`n[ç»“è®º] æ‰€æœ‰åç«¯æµ‹è¯•é€šè¿‡ âœ…" -ForegroundColor Green
    exit 0
} else {
    Write-Host "`n[ç»“è®º] éƒ¨åˆ†åç«¯æµ‹è¯•å¤±è´¥ âŒ" -ForegroundColor Red
    exit 1
}
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§è„šæœ¬

**æ–‡ä»¶:** `monitor-health.ps1`

```powershell
# DreamBook å¥åº·ç›‘æ§è„šæœ¬
# æŒç»­ç›‘æ§åº”ç”¨æ€§èƒ½å’Œå¥åº·çŠ¶æ€

param(
    [int]$IntervalSeconds = 60,
    [int]$DurationMinutes = 0,  # 0 = æ— é™è¿è¡Œ
    [string]$LogPath = "C:\kiosk\backups\monitoring\health-$(Get-Date -Format 'yyyyMMdd').csv"
)

# åˆ›å»ºæ—¥å¿—ç›®å½•
$LogDir = Split-Path $LogPath -Parent
if (-not (Test-Path $LogDir)) {
    New-Item -ItemType Directory -Path $LogDir -Force | Out-Null
}

# å†™å…¥ CSV æ ‡é¢˜
if (-not (Test-Path $LogPath)) {
    "Timestamp,CPU%,MemoryMB,ThreadCount,HandleCount,BackendPort,BackendResponse,Status" | Out-File -FilePath $LogPath -Encoding UTF8
}

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  DreamBook å¥åº·ç›‘æ§" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "ç›‘æ§é—´éš”: $IntervalSeconds ç§’" -ForegroundColor White
Write-Host "æ—¥å¿—æ–‡ä»¶: $LogPath" -ForegroundColor White
if ($DurationMinutes -gt 0) {
    Write-Host "è¿è¡Œæ—¶é•¿: $DurationMinutes åˆ†é’Ÿ" -ForegroundColor White
} else {
    Write-Host "è¿è¡Œæ¨¡å¼: æŒç»­ç›‘æ§ (Ctrl+C åœæ­¢)" -ForegroundColor White
}
Write-Host ""

$StartTime = Get-Date
$Iteration = 0

while ($true) {
    $Iteration++
    $Now = Get-Date

    # æ£€æŸ¥è¿è¡Œæ—¶é•¿
    if ($DurationMinutes -gt 0) {
        $Elapsed = ($Now - $StartTime).TotalMinutes
        if ($Elapsed -ge $DurationMinutes) {
            Write-Host "`n[å®Œæˆ] ç›‘æ§æ—¶é•¿è¾¾åˆ° $DurationMinutes åˆ†é’Ÿï¼Œåœæ­¢ç›‘æ§" -ForegroundColor Green
            break
        }
    }

    Write-Host "[$($Now.ToString('HH:mm:ss'))] é‡‡é›† #$Iteration" -ForegroundColor Cyan

    try {
        # è·å–åº”ç”¨è¿›ç¨‹
        $Process = Get-Process -Name "dreambook" -ErrorAction SilentlyContinue

        if ($Process) {
            # CPU ä½¿ç”¨ç‡
            $CPU = [math]::Round((Get-Counter "\Process($($Process.Name))\% Processor Time").CounterSamples.CookedValue, 2)

            # å†…å­˜ä½¿ç”¨
            $MemoryMB = [math]::Round($Process.WorkingSet64 / 1MB, 2)

            # çº¿ç¨‹æ•°
            $ThreadCount = $Process.Threads.Count

            # å¥æŸ„æ•°
            $HandleCount = $Process.HandleCount

            # åç«¯ç«¯å£æ£€æŸ¥
            $BackendPort = (Get-NetTCPConnection -LocalPort 3000 -State Listen -ErrorAction SilentlyContinue) -ne $null

            # åç«¯å“åº”æ£€æŸ¥
            try {
                $BackendResponse = Invoke-WebRequest -Uri "http://localhost:3000/api/health" -UseBasicParsing -TimeoutSec 5 -ErrorAction Stop
                $BackendOk = $BackendResponse.StatusCode -eq 200
            } catch {
                $BackendOk = $false
            }

            # åˆ¤æ–­å¥åº·çŠ¶æ€
            $Status = "Healthy"
            if ($CPU -gt 50) { $Status = "High CPU" }
            if ($MemoryMB -gt 500) { $Status = "High Memory" }
            if (-not $BackendPort) { $Status = "Backend Down" }
            if (-not $BackendOk) { $Status = "Backend Error" }

            # è¾“å‡ºåˆ°æ§åˆ¶å°
            $Color = if ($Status -eq "Healthy") { "Green" } else { "Yellow" }
            Write-Host "       CPU: $CPU% | å†…å­˜: $MemoryMB MB | çº¿ç¨‹: $ThreadCount | å¥æŸ„: $HandleCount | çŠ¶æ€: $Status" -ForegroundColor $Color

            # å†™å…¥ CSV
            "$($Now.ToString('yyyy-MM-dd HH:mm:ss')),$CPU,$MemoryMB,$ThreadCount,$HandleCount,$BackendPort,$BackendOk,$Status" | Out-File -FilePath $LogPath -Append -Encoding UTF8
        } else {
            Write-Host "       [è­¦å‘Š] åº”ç”¨è¿›ç¨‹æœªè¿è¡Œ" -ForegroundColor Red
            "$($Now.ToString('yyyy-MM-dd HH:mm:ss')),0,0,0,0,False,False,Process Down" | Out-File -FilePath $LogPath -Append -Encoding UTF8
        }
    } catch {
        Write-Host "       [é”™è¯¯] ç›‘æ§å¼‚å¸¸: $_" -ForegroundColor Red
    }

    # ç­‰å¾…ä¸‹ä¸€æ¬¡é‡‡é›†
    Start-Sleep -Seconds $IntervalSeconds
}
```

---

## ğŸ¯ ä½¿ç”¨è¯´æ˜

### è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```powershell
# åŸºæœ¬è¿è¡Œ
.\test-all.ps1

# è¯¦ç»†è¾“å‡º
.\test-all.ps1 -Verbose

# ä¸ç”ŸæˆæŠ¥å‘Š
.\test-all.ps1 -GenerateReport:$false
```

### è¿è¡Œåç«¯æµ‹è¯•

```powershell
# é»˜è®¤ localhost:3000
.\test-backend.ps1

# è‡ªå®šä¹‰ URL
.\test-backend.ps1 -BaseUrl "http://192.168.1.100:3000"
```

### å¯åŠ¨å¥åº·ç›‘æ§

```powershell
# æŒç»­ç›‘æ§ï¼ˆæ¯åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡ï¼‰
.\monitor-health.ps1

# è‡ªå®šä¹‰é—´éš”ï¼ˆæ¯ 30 ç§’é‡‡é›†ä¸€æ¬¡ï¼‰
.\monitor-health.ps1 -IntervalSeconds 30

# è¿è¡ŒæŒ‡å®šæ—¶é•¿ï¼ˆç›‘æ§ 1 å°æ—¶ï¼‰
.\monitor-health.ps1 -DurationMinutes 60
```

---

## ğŸ“… é…ç½®å®šæ—¶ä»»åŠ¡

### æ¯æ—¥è‡ªåŠ¨æµ‹è¯•

```cmd
# åˆ›å»ºæ¯æ—¥æµ‹è¯•ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ 3 ç‚¹ï¼‰
schtasks /create /tn "DreamBook Daily Test" /tr "powershell.exe -ExecutionPolicy Bypass -File C:\kiosk\scripts\test-all.ps1" /sc daily /st 03:00 /ru SYSTEM

# éªŒè¯ä»»åŠ¡
schtasks /query /tn "DreamBook Daily Test"
```

### æŒç»­å¥åº·ç›‘æ§

```cmd
# åˆ›å»ºå¯åŠ¨æ—¶è¿è¡Œçš„ç›‘æ§ä»»åŠ¡
schtasks /create /tn "DreamBook Health Monitor" /tr "powershell.exe -ExecutionPolicy Bypass -File C:\kiosk\scripts\monitor-health.ps1" /sc onstart /ru SYSTEM

# éªŒè¯ä»»åŠ¡
schtasks /query /tn "DreamBook Health Monitor"
```

---

**æœ€åæ›´æ–°:** 2026-01-13
**ç‰ˆæœ¬:** 1.0
**çŠ¶æ€:** âœ… å®Œæˆ
