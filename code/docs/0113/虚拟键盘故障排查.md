# 虚拟键盘故障排查指南

## 问题描述
admin 用户和 kiosk 用户下，触摸输入框时虚拟键盘不弹出。

## 📋 快速诊断清单

### 1. 系统环境检查

**Windows 版本确认**
```powershell
winver  # 查看 Windows 版本
```

**触摸屏支持确认**
```powershell
# 检查设备管理器 → 人体学输入设备
# 应该能看到 HID 兼容的触摸屏
```

### 2. 服务状态检查

**检查 TabletInputService 服务**
```powershell
# 查看服务状态
Get-Service TabletInputService

# 应该显示：
# Status   Name                 DisplayName
# ------   ----                 -----------
# Running  TabletInputService   Touch Keyboard and Handwriting Panel Service
```

**如果服务未运行**
```powershell
# 以管理员身份运行
Start-Service TabletInputService
Set-Service TabletInputService -StartupType Automatic
```

### 3. 运行自动诊断脚本

**方法 A：基础诊断**
```cmd
# 双击运行或命令行执行
C:\path\to\diagnose-keyboard.bat
```

**方法 B：Windows 11 专用修复**
```cmd
# 以管理员身份运行
C:\path\to\fix-win11-keyboard.bat
```

### 4. 应用日志检查

**查看应用日志文件**
```
位置：C:\Users\[用户名]\dreambook-logs\app-[日期].log

搜索关键字：
  - [虚拟键盘]
  - electronAPI
  - show-virtual-keyboard
  - TabTip.exe
```

**应该看到的正常日志：**
```
[虚拟键盘] ===== 开始启动虚拟键盘 =====
[虚拟键盘] 方法 1: PowerShell COM 接口
[虚拟键盘] ✅ PowerShell 调用成功
```

**异常日志示例：**
```
[虚拟键盘] TabTip.exe 启动失败: [错误信息]
[虚拟键盘] ❌ 所有方法均失败
```

### 5. 浏览器控制台检查

**新版本已启用 DevTools，查看控制台：**

1. 运行 `梦境解析.exe`
2. DevTools 会自动打开
3. 切换到 Console 标签
4. 点击输入框
5. 查看日志输出

**正常情况应该看到：**
```
[虚拟键盘] Hook 初始化
[虚拟键盘] electronAPI 存在: true
[虚拟键盘] 平台: win32
[虚拟键盘] ===== Focus 事件触发 =====
[虚拟键盘] 尝试显示键盘 - 触发位置: focus
[虚拟键盘] 调用成功, 结果: true
```

**异常情况：**
```
[虚拟键盘] electronAPI 不存在，可能在浏览器环境中运行
```
→ 说明 preload 脚本加载失败

## 🔧 常见问题和解决方案

### 问题 1: TabletInputService 服务未运行

**症状：**
- 手动运行 `TabTip.exe` 也不弹出键盘
- 系统设置中找不到触摸键盘选项

**解决方案：**
```powershell
# 以管理员身份运行 PowerShell
Start-Service TabletInputService
Set-Service TabletInputService -StartupType Automatic

# 检查服务状态
Get-Service TabletInputService

# 如果启动失败，尝试修复
sfc /scannow
DISM /Online /Cleanup-Image /RestoreHealth
```

---

### 问题 2: electronAPI 为 undefined

**症状：**
- Console 显示 `electronAPI 不存在`
- 虚拟键盘 Hook 无法调用 IPC

**可能原因：**
1. preload 脚本路径错误
2. contextIsolation 配置问题
3. 文件权限问题

**解决方案：**

**检查 preload 文件是否存在：**
```
应用目录\resources\app.asar（打包后）
或
应用目录\dist-electron\preload.cjs（开发环境）
```

**查看主进程日志：**
```
日志中应该有：
✅ Preload 文件存在
Preload 路径: [路径]
```

**如果显示文件不存在：**
- 检查打包配置 `package.json` 的 `build.files`
- 确认 `dist-electron/preload.cjs` 文件已生成
- 重新打包应用

---

### 问题 3: 日志显示调用成功但键盘不弹出

**症状：**
- Console 显示 `[虚拟键盘] 调用成功, 结果: true`
- 但键盘仍然不显示

**可能原因：**
1. Windows 11 策略限制
2. 窗口模式问题（全屏/kiosk 模式）
3. 触摸屏未被识别

**解决方案 A：Windows 11 策略配置**
```cmd
# 以管理员身份运行
C:\path\to\fix-win11-keyboard.bat

# 或手动执行：
reg add "HKEY_CURRENT_USER\Software\Microsoft\TabletTip\1.7" /v EnableDesktopModeAutoInvoke /t REG_DWORD /d 1 /f
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v TouchKeyboardVisibility /t REG_DWORD /d 1 /f
```

**解决方案 B：窗口模式优化**

应用已使用"伪全屏"模式（高度减 1 像素），理论上不应该有问题。

如果仍有问题，检查 `electron/main.ts` 第589-599行：
```typescript
mainWindow?.setBounds({
  x: 0,
  y: 0,
  width: screenWidth,
  height: screenHeight - 1  // 关键：减1像素
})
```

**解决方案 C：手动启用触摸模式**
```powershell
# 以管理员身份运行
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\ImmersiveShell" /v TabletMode /t REG_DWORD /d 1 /f

# 重启 Explorer
taskkill /f /im explorer.exe
start explorer.exe
```

---

### 问题 4: 键盘弹出但立即消失

**症状：**
- 键盘闪烁一下就消失
- 日志显示多次调用

**可能原因：**
- 焦点丢失
- 窗口层级问题
- 防抖机制失效

**解决方案：**

**检查防抖配置** (`src/hooks/useVirtualKeyboard.ts`):
```typescript
const DEBOUNCE_DELAY = 500 // 增加到 1000ms
```

**检查窗口配置** (`electron/main.ts`):
```typescript
alwaysOnTop: false,  // 不要设为 true
kiosk: false,        // 不要使用 kiosk 模式
```

---

### 问题 5: 多用户环境下的权限问题

**症状：**
- admin 用户可以，kiosk 用户不可以
- 或者相反

**可能原因：**
- 用户权限差异
- 注册表配置仅针对单个用户
- 服务运行权限

**解决方案：**

**为所有用户配置注册表：**
```powershell
# 以管理员身份运行
# 配置机器级别（所有用户）
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\TabletTip" /v EnableDesktopModeAutoInvoke /t REG_DWORD /d 1 /f

# 配置当前用户
reg add "HKEY_CURRENT_USER\Software\Microsoft\TabletTip\1.7" /v EnableDesktopModeAutoInvoke /t REG_DWORD /d 1 /f

# 重启应用测试
```

**检查文件权限：**
```powershell
# 确保应用目录对所有用户可读可执行
icacls "C:\kiosk\dreambook" /grant Users:RX /T
```

---

## 🧪 手动测试虚拟键盘

### 测试 1: 系统级键盘测试

**打开任务管理器**
```
Ctrl + Shift + Esc
```

**打开记事本**
```
notepad.exe
```

**点击输入框，看是否弹出虚拟键盘**
- 如果不弹出 → 系统配置问题
- 如果弹出 → 应用配置问题

---

### 测试 2: 命令行测试

```powershell
# 方法 1: 直接运行 TabTip.exe
& "C:\Program Files\Common Files\microsoft shared\ink\TabTip.exe"

# 方法 2: URI 协议
start ms-availableinsettings:touch-keyboard

# 方法 3: PowerShell COM
Add-Type -AssemblyName System.Windows.Forms
$null = [System.Windows.Forms.SendKeys]::SendWait('{F1}')
```

---

### 测试 3: 应用内 IPC 测试

**在 DevTools Console 中执行：**
```javascript
// 检查 API 是否存在
console.log('electronAPI:', window.electronAPI)

// 手动调用虚拟键盘
window.electronAPI.showVirtualKeyboard()
  .then(result => console.log('结果:', result))
  .catch(error => console.error('错误:', error))
```

---

## 📊 诊断决策树

```
虚拟键盘不弹出
│
├─ 系统记事本可以弹出？
│  ├─ 是 → 应用配置问题
│  │  ├─ DevTools 中 electronAPI 存在？
│  │  │  ├─ 是 → IPC 通信问题
│  │  │  │  └─ 检查 main.ts 中的 ipcMain.handle
│  │  │  └─ 否 → preload 脚本问题
│  │  │     └─ 检查 preload.cjs 是否存在
│  │  └─ 手动调用 showVirtualKeyboard() 有效？
│  │     ├─ 是 → 事件绑定问题
│  │     │  └─ 检查 useVirtualKeyboard Hook
│  │     └─ 否 → 主进程调用失败
│  │        └─ 查看日志 ~/dreambook-logs/
│  │
│  └─ 否 → 系统配置问题
│     ├─ TabletInputService 运行？
│     │  ├─ 是 → Windows 策略问题
│     │  │  └─ 运行 fix-win11-keyboard.bat
│     │  └─ 否 → 启动服务
│     │     └─ Start-Service TabletInputService
│     │
│     └─ TabTip.exe 存在？
│        ├─ 是 → 权限或策略问题
│        └─ 否 → 系统文件损坏
│           └─ sfc /scannow
```

---

## 🚀 快速修复流程（推荐）

**步骤 1：运行系统修复脚本**
```cmd
# 以管理员身份运行
C:\path\to\fix-win11-keyboard.bat
```

**步骤 2：重启触摸键盘服务**
```powershell
Restart-Service TabletInputService
```

**步骤 3：部署新的调试版本**
1. 复制 `release/win-unpacked/` 到设备
2. 运行 `梦境解析.exe`
3. DevTools 自动打开

**步骤 4：测试并查看日志**
1. 点击输入框
2. 查看 Console 日志
3. 查看文件日志 `~/dreambook-logs/app-*.log`

**步骤 5：根据日志定位问题**
- electronAPI 不存在 → preload 问题
- 调用失败 → IPC 通信问题
- 调用成功但不弹出 → Windows 策略问题

---

## 📞 联系技术支持

如果以上方法都无法解决，请提供以下信息：

1. **Windows 版本**
   ```
   winver 截图
   ```

2. **服务状态**
   ```powershell
   Get-Service TabletInputService | Format-List *
   ```

3. **应用日志**
   ```
   ~/dreambook-logs/app-[日期].log
   ```

4. **Console 截图**
   - DevTools Console 的完整输出

5. **手动测试结果**
   - 记事本能否弹出键盘？
   - TabTip.exe 能否手动启动？
   - Console 中手动调用 API 的结果？

---

**最后更新：** 2026-01-13
**适用版本：** DreamBook v1.0+
**支持平台：** Windows 10/11 (x64)
