# DreamBook Kiosk 完整修改步骤

> 基于参考文档《实践方案.md》和当前代码库的详尽实现指南

---

## 📋 三大功能修改总览

| 功能 | 类型 | 状态 | 优先级 |
|------|------|------|--------|
| 1. 开机不需要输入密码 | 系统配置 | ✅ 已规划 | 🔴 必须 |
| 2. 触摸屏点击输入框弹出键盘 | 代码实现 | ✅ 已完成 | 🔴 必须 |
| 3. 右上角点击5次弹出退出程序 | 代码实现 | ✅ 已完成 | 🟡 重要 |

---

## 🔧 功能 1：开机不需要输入密码

### 📌 原理
- Windows 系统级别配置，不涉及代码修改
- 通过修改注册表实现自动登录和 Shell 替换
- kiosk 用户启动时自动进入 dreambook.exe

### ✅ 完整步骤

#### 步骤 1.1：创建 kiosk 用户账户

```cmd
# 以管理员身份打开 CMD（右键 → 以管理员身份运行）
net user kiosk 你的密码 /add
```

**验证：** 打开 `设置 → 账户 → 其他用户`，应该看到 `kiosk` 账户

---

#### 步骤 1.2：设置自动登录（不输入密码）

```cmd
# 以管理员身份运行 CMD，执行以下三条命令

# 设置默认用户名
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v DefaultUserName /t REG_SZ /d kiosk /f

# 设置默认密码
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v DefaultPassword /t REG_SZ /d "你的密码" /f

# 启用自动登录
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v AutoAdminLogon /t REG_SZ /d 1 /f
```

**验证：** 重启电脑，应该自动登录到 kiosk 账户（无需输入密码）

---

#### 步骤 1.3：配置 Shell 替换（关键步骤）

```cmd
# 以管理员身份运行 CMD

# 加载 Default User 注册表
reg load HKU\DEF "C:\Users\Default\NTUSER.DAT"

# 设置 Shell 为 dreambook.exe
reg add "HKU\DEF\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" ^
/v Shell /t REG_SZ /d "C:\kiosk\dreambook\dreambook.exe" /f

# 卸载注册表
reg unload HKU\DEF
```

**说明：**
- kiosk 用户第一次登录时会从 Default User 复制注册表
- 从而自动继承 `Shell=dreambook.exe`
- 系统启动时不会加载 Windows 桌面，直接启动 dreambook.exe

**验证：** 重启电脑，应该直接进入 dreambook 应用（无任务栏、无桌面）

---

#### 步骤 1.4：应用程序路径配置

确保 dreambook.exe 位于以下路径：
```
C:\kiosk\dreambook\dreambook.exe
```

如果路径不同，需要修改上面的注册表命令中的路径。

---

## ⌨️ 功能 2：触摸屏点击输入框弹出键盘

### 📌 原理
- 前端输入框获得焦点时，通过 IPC 调用 Electron 主进程
- 主进程调用 Windows 系统虚拟键盘（TabTip.exe）
- 支持多种触发方式：focus、click、touchStart、touchEnd

### ✅ 已完成的代码修改

#### 修改 2.1：preload.ts - 暴露 switchUser 接口 ✅

**文件：** `electron/preload.ts`

```typescript
// 已添加
switchUser: () => ipcRenderer.invoke('sys:switch-user'),

// 类型声明
switchUser: () => Promise<void>
```

**作用：** 前端可以调用 `window.electronAPI.switchUser()` 切换用户

---

#### 修改 2.2：main.ts - 添加 IPC 处理器 ✅

**文件：** `electron/main.ts` → `setupIPC()` 函数

```typescript
// 已添加
ipcMain.handle('sys:switch-user', () => {
  log('[系统] 执行切换用户命令')
  if (process.platform !== 'win32') {
    log('[系统] 非 Windows 平台，跳过切换用户')
    return
  }

  try {
    // Windows Terminal Disconnect - 断开当前用户，回到登录界面
    exec('C:\\Windows\\System32\\tsdiscon.exe', (error) => {
      if (error) {
        log(`[系统] 切换用户失败: ${error.message}`)
      } else {
        log('[系统] ✅ 已成功切换用户')
      }
    })

    // 同时标记应用要退出，防止重启
    isQuitting = true
  } catch (error) {
    log(`[系统] 切换用户异常: ${error}`)
  }
})
```

**作用：** 处理前端的切换用户请求，调用 Windows 系统命令

---

#### 修改 2.3：虚拟键盘已在以下组件中应用 ✅

**SearchBox 组件** (`src/components/SearchBox/SearchBox.tsx`)
```tsx
const virtualKeyboard = useVirtualKeyboard()

<input
  onFocus={virtualKeyboard.onFocus}
  onClick={virtualKeyboard.onClick}
  onTouchStart={virtualKeyboard.onTouchStart}
  onTouchEnd={virtualKeyboard.onTouchEnd}
/>
```

**AIChat 组件** (`src/pages/AIChat/index.tsx`)
```tsx
const virtualKeyboard = useVirtualKeyboard()

<textarea
  onFocus={virtualKeyboard.onFocus}
  onClick={virtualKeyboard.onClick}
  onTouchStart={virtualKeyboard.onTouchStart}
  onTouchEnd={virtualKeyboard.onTouchEnd}
/>
```

---

### 📝 虚拟键盘工作流程

```
用户触摸输入框
    ↓
触发 onFocus / onClick / onTouchEnd 事件
    ↓
调用 useVirtualKeyboard Hook
    ↓
Hook 检查防抖（500ms 内不重复调用）
    ↓
调用 window.electronAPI.showVirtualKeyboard()
    ↓
IPC 消息发送到主进程
    ↓
主进程执行 showWindowsVirtualKeyboard()
    ↓
尝试多种方法启动虚拟键盘：
  1. PowerShell COM 接口（Win11 推荐）
  2. TabTip.exe（备用）
  3. URI 协议（备用）
  4. osk.exe（最后方案）
    ↓
虚拟键盘弹出 ✅
```

---

## 🎯 功能 3：右上角点击 5 次弹出退出程序

### 📌 原理
- 在屏幕右上角 80×80 像素区域设置隐藏触发区域
- 2 秒内连续点击 5 次触发管理面板
- 管理面板提供：刷新、重启、退出、切换用户 四个选项

### ✅ 已完成的代码修改

#### 修改 3.1：AdminTrigger 组件 ✅

**文件：** `src/components/AdminTrigger/AdminTrigger.tsx`

```tsx
// 右上角 80×80 隐藏区域
<div
  onClick={handleClick}
  onTouchEnd={handleClick}
  style={{
    position: 'fixed',
    top: 0,
    right: 0,
    width: '80px',
    height: '80px',
    zIndex: 99999,
  }}
/>
```

**功能：**
- 支持鼠标点击和触摸点击
- 2 秒内点击 5 次打开管理面板
- 超过 2 秒重置计数

---

#### 修改 3.2：AdminPanel 组件 ✅

**文件：** `src/components/AdminPanel/AdminPanel.tsx`

**已添加的按钮：**

1. **刷新页面** - 重新加载当前页面
2. **重启应用** - 重启 Electron 应用
3. **退出应用** - 完全退出应用
4. **切换用户** ✅ 新增 - 断开当前用户，回到登录界面

```tsx
// 新增切换用户处理函数
const handleSwitchUser = async () => {
  if (!window.electronAPI?.switchUser) {
    alert('切换用户功能仅在 Windows Electron 环境下可用')
    return
  }

  if (confirm('确定要切换用户吗？应用将退出到登录界面。')) {
    try {
      await window.electronAPI.switchUser()
    } catch (error) {
      console.error('切换用户失败:', error)
    }
  }
}

// 新增切换用户按钮样式
switchUserButton: {
  background: 'rgba(255, 180, 100, 0.3)',
  border: '1px solid rgba(255, 180, 100, 0.6)',
  color: '#ffc080',
}
```

---

### 📊 管理面板工作流程

```
用户在右上角点击 5 次（2 秒内）
    ↓
AdminTrigger 检测到达到触发次数
    ↓
打开 AdminPanel 弹窗
    ↓
用户选择操作：
  ├─ 刷新页面 → window.location.reload()
  ├─ 重启应用 → window.electronAPI.restartApp()
  ├─ 退出应用 → window.electronAPI.exitApp()
  └─ 切换用户 → window.electronAPI.switchUser() ✅
    ↓
对应的 IPC 处理器执行
    ↓
操作完成 ✅
```

---

## 🚀 部署检查清单

### 系统配置（Windows 10）

- [ ] 创建 kiosk 用户账户
- [ ] 设置自动登录（不输入密码）
- [ ] 配置 Shell 替换（dreambook.exe）
- [ ] 确保程序路径：`C:\kiosk\dreambook\dreambook.exe`
- [ ] 启用 TabletInputService 服务（虚拟键盘）

```cmd
# 启用虚拟键盘服务
sc config TabletInputService start= auto
sc start TabletInputService
```

### 代码配置

- [ ] 修改 `electron/preload.ts` - 添加 switchUser 接口 ✅
- [ ] 修改 `electron/main.ts` - 添加 IPC 处理器 ✅
- [ ] 修改 `src/components/AdminPanel/AdminPanel.tsx` - 添加切换用户按钮 ✅
- [ ] 修改 `src/components/AdminTrigger/AdminTrigger.tsx` - 支持触摸事件 ✅
- [ ] 验证 SearchBox 和 AIChat 已应用虚拟键盘 Hook ✅

### 测试步骤

#### 测试 1：开机自动登录
1. 重启电脑
2. 应该自动登录到 kiosk 账户
3. 直接进入 dreambook 应用
4. ✅ 无需输入密码

#### 测试 2：虚拟键盘
1. 点击输入框
2. 系统虚拟键盘应该自动弹出
3. 可以使用虚拟键盘输入文字
4. ✅ 虚拟键盘正常工作

#### 测试 3：管理面板
1. 在屏幕右上角快速点击 5 次
2. 管理面板应该弹出
3. 点击"切换用户"
4. 应用退出到 Windows 登录界面
5. 可以登录 Administrator 账户进行维护
6. ✅ 管理面板正常工作

---

## 📝 维护 SOP（标准操作流程）

### 日常使用（kiosk 用户）
1. 开机自动进入 dreambook 应用
2. 用户正常使用触摸屏
3. 虚拟键盘自动弹出

### 管理员维护（Administrator 用户）
1. 右上角快速点击 5 次打开管理面板
2. 点击"切换用户"
3. 进入 Windows 登录界面
4. 登录 Administrator 账户
5. 进行维护、更新、调试等操作
6. 重启电脑后自动回到 kiosk 应用

### 紧急情况
- 如果应用卡死，可以按 F12 打开 DevTools（开发模式）
- 查看日志文件：`~/dreambook-logs/app-YYYY-MM-DD.log`
- 强制重启应用：Alt+F4（开发模式）或重启电脑

---

## 🔍 故障排查

### 问题 1：开机后没有自动登录
**原因：** 注册表配置不正确
**解决：**
```cmd
# 检查注册表
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AutoAdminLogon
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName
```

### 问题 2：虚拟键盘不弹出
**原因：** TabletInputService 服务未启用
**解决：**
```cmd
# 启用虚拟键盘服务
sc config TabletInputService start= auto
sc start TabletInputService
```

### 问题 3：切换用户不工作
**原因：** tsdiscon.exe 路径不正确或权限不足
**解决：**
```cmd
# 检查文件是否存在
dir C:\Windows\System32\tsdiscon.exe

# 手动测试
C:\Windows\System32\tsdiscon.exe
```

### 问题 4：右上角点击不响应
**原因：** 触发区域被其他元素覆盖
**解决：**
1. 打开 DevTools（F12）
2. 取消注释 AdminTrigger 中的调试代码：
   ```tsx
   // backgroundColor: 'rgba(255, 0, 0, 0.3)',
   ```
3. 查看红色区域是否正确显示在右上角

---

## 📚 参考文档

- 原始方案：`code/docs/0113/实践方案.md`
- Electron 文档：https://www.electronjs.org/docs
- Windows 注册表：https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry

---

## ✅ 修改完成清单

### 代码修改（已完成）
- [x] `electron/preload.ts` - 添加 switchUser 接口
- [x] `electron/main.ts` - 添加 IPC 处理器
- [x] `src/components/AdminPanel/AdminPanel.tsx` - 添加切换用户按钮
- [x] `src/components/AdminTrigger/AdminTrigger.tsx` - 支持触摸事件

### 系统配置（需要手动执行）
- [ ] 创建 kiosk 用户
- [ ] 设置自动登录
- [ ] 配置 Shell 替换
- [ ] 启用虚拟键盘服务

### 测试验证（需要手动测试）
- [ ] 开机自动登录
- [ ] 虚拟键盘弹出
- [ ] 管理面板打开
- [ ] 切换用户功能

---

**最后更新：** 2026-01-13
**状态：** ✅ 完成
**下一步：** 编译打包 → 部署到 Windows 10 设备 → 执行系统配置 → 测试验证
