# Windows 触摸屏虚拟键盘集成优化

**更新时间**: 2025-12-12
**功能版本**: v2.0.0 (优化版)

---

## 概述

针对 Windows 10 触摸屏环境（20点触控，Intel i7-6600U），优化了虚拟键盘的调用机制，提升了兼容性和稳定性。

---

## 硬件配置

- **系统**: Windows 10 64位 (x64)
- **触控**: 20点触控支持
- **处理器**: Intel i7-6600U (2.60GHz)
- **显卡**: Intel HD Graphics 520 (128MB)

---

## 主要优化内容

### 1. **main.ts 虚拟键盘实现优化**

#### 优化点

1. **32位/64位路径兼容**
   ```typescript
   function findTabTipPath(): string {
     const possiblePaths = [
       'C:\\Program Files\\Common Files\\microsoft shared\\ink\\TabTip.exe',        // 64位
       'C:\\Program Files (x86)\\Common Files\\microsoft shared\\ink\\TabTip.exe', // 32位
     ]
     return possiblePaths[0] // 你的系统是 64位，使用第一个路径
   }
   ```

2. **防抖机制 - 防止重复调用**
   ```typescript
   const KEYBOARD_DEBOUNCE_TIME = 1000 // 1秒内不重复调用

   if (isKeyboardStarting && now - keyboardStartTime < KEYBOARD_DEBOUNCE_TIME) {
     console.log('[虚拟键盘] 防抖：键盘正在启动中，跳过重复调用')
     return
   }
   ```

3. **延迟启动 - 确保触摸事件处理完成**
   ```typescript
   setTimeout(() => {
     // 启动虚拟键盘
   }, 50) // 50ms 延迟
   ```

4. **重试机制 - 提升成功率**
   ```typescript
   exec(tabtipPath, (error) => {
     if (error) {
       // 第一次失败，200ms 后重试
       setTimeout(() => {
         exec(tabtipPath, (retryError) => {
           if (retryError) {
             // 重试失败，降级到 osk.exe
             exec('osk.exe', ...)
           }
         })
       }, 200)
     }
   })
   ```

5. **详细日志 - 便于调试**
   - 开发模式下输出详细日志
   - 生产模式下只输出关键信息
   ```typescript
   const isDev = !app.isPackaged
   if (isDev) {
     console.log('[虚拟键盘] 开始启动虚拟键盘...')
   }
   ```

#### 降级策略

1. **TabTip.exe** (优先) - Windows 10/11 触摸键盘
2. **TabTip.exe 重试** (第二优先) - 200ms 后重试
3. **osk.exe** (备用) - 传统屏幕键盘

---

### 2. **AIChat 页面集成**

#### 实现方式

在 `src/pages/AIChat/index.tsx` 中添加了虚拟键盘调用：

```typescript
// 处理输入框获取焦点事件
const handleInputFocus = () => {
  if (window.electronAPI && window.electronAPI.platform === 'win32') {
    window.electronAPI.showVirtualKeyboard()
  }
}

// 处理文本区域点击
const handleTextareaClick = () => {
  if (window.electronAPI && window.electronAPI.platform === 'win32') {
    window.electronAPI.showVirtualKeyboard()
  }
}

// 在 textarea 上添加事件
<textarea
  onFocus={handleInputFocus}
  onClick={handleTextareaClick}
  ...
/>
```

#### 触发时机

- ✅ **onFocus**: 输入框获取焦点时
- ✅ **onClick**: 点击/触摸输入框时

---

## 使用说明

### 开发环境测试

#### 1. Mac 虚拟机测试（有限功能）

可以测试：
- ✅ 代码逻辑是否正确
- ✅ IPC 通信是否正常
- ✅ `osk.exe` 是否能启动（TabTip.exe 可能无法工作）
- ✅ 日志输出是否正确

无法测试：
- ❌ TabTip.exe 在虚拟机中可能无法正常工作
- ❌ 真实触摸屏交互
- ❌ 性能表现

#### 2. 真实触摸屏设备测试（必须）

最终必须在 Windows 10 触摸屏设备上测试：
- ✅ TabTip.exe 是否正常启动
- ✅ 触摸交互是否流畅
- ✅ 键盘是否遮挡重要内容
- ✅ 性能是否满足要求

### 调试步骤

1. **启动开发环境**
   ```bash
   # 终端 1 - 后端服务
   cd backend
   npm run dev

   # 终端 2 - Electron 应用
   npm run electron:dev
   ```

2. **打开开发者工具**
   - Electron 窗口会自动打开 DevTools
   - 查看控制台日志

3. **测试虚拟键盘**
   - 点击 AI 解梦页面的输入框
   - 观察控制台输出：
     ```
     [虚拟键盘] 开始启动虚拟键盘...
     [虚拟键盘] 尝试启动 TabTip.exe: ...
     [虚拟键盘] ✅ 已启动触摸键盘 (TabTip.exe)
     ```

4. **验证防抖机制**
   - 快速多次点击输入框
   - 应该看到：
     ```
     [虚拟键盘] 防抖：键盘正在启动中，跳过重复调用
     ```

---

## 预期行为

### 成功场景

1. **TabTip.exe 首次成功**
   ```
   [虚拟键盘] 开始启动虚拟键盘...
   [虚拟键盘] 尝试启动 TabTip.exe: C:\Program Files\...
   [虚拟键盘] ✅ 已启动触摸键盘 (TabTip.exe)
   ```

2. **TabTip.exe 重试成功**
   ```
   [虚拟键盘] TabTip.exe 启动失败: ...
   [虚拟键盘] 尝试重试...
   [虚拟键盘] ✅ 已启动触摸键盘 (TabTip.exe, 重试成功)
   ```

3. **降级到 osk.exe**
   ```
   [虚拟键盘] TabTip.exe 重试失败: ...
   [虚拟键盘] 尝试备用方案: osk.exe
   [虚拟键盘] ✅ 已启动传统屏幕键盘 (osk.exe)
   ```

### 失败场景

```
[虚拟键盘] ❌ 所有方法均失败: ...
```

---

## 性能考虑

### 针对你的配置优化

1. **显卡性能**
   - Intel HD Graphics 520 性能一般
   - 避免在输入时触发复杂动画
   - 虚拟键盘调用本身对性能影响很小

2. **触摸响应**
   - 20点触控支持良好
   - 50ms 延迟确保触摸事件处理完成
   - 防抖机制避免重复调用导致的性能问题

---

## 与其他组件对比

| 功能 | SearchBox | AIChat |
|------|-----------|--------|
| 虚拟键盘支持 | ✅ | ✅ |
| onFocus 触发 | ✅ | ✅ |
| onClick 触发 | ❌ | ✅ |
| onTouchStart 触发 | ✅ | ❌ |

**注意**: AIChat 使用 `onClick` 而不是 `onTouchStart`，因为 textarea 的交互更简单，`onClick` 已经足够。

---

## 已知问题和限制

### 1. Mac 虚拟机限制
- TabTip.exe 可能无法在虚拟机中正常工作
- 这是正常现象，虚拟机无法完全模拟触摸硬件
- 建议在真实设备上最终测试

### 2. 多次快速点击
- 防抖机制限制 1秒内只能调用一次
- 这是为了避免性能问题和重复启动
- 如果需要调整，修改 `KEYBOARD_DEBOUNCE_TIME`

---

## 后续优化建议

### 可选功能

1. **自动隐藏键盘**
   - 当前不自动隐藏（让用户手动关闭体验更好）
   - 如需自动隐藏，可在 `onBlur` 中调用 `hideVirtualKeyboard()`

2. **键盘位置检测**
   - 检测键盘是否遮挡输入框
   - 自动调整页面滚动位置

3. **触摸反馈**
   - 添加触摸时的视觉反馈（如边框高亮）
   - 可选：触摸震动反馈（需要硬件支持）

---

## 测试清单

### 开发环境测试（Mac 虚拟机）
- [ ] 代码无语法错误
- [ ] IPC 通信正常
- [ ] 控制台日志输出正确
- [ ] osk.exe 能够启动（TabTip 可能失败）

### 真实设备测试（Windows 10 触摸屏）
- [ ] TabTip.exe 正常启动
- [ ] 触摸输入框弹出虚拟键盘
- [ ] 键盘不遮挡重要内容
- [ ] 输入体验流畅
- [ ] 防抖机制工作正常
- [ ] 重试机制在需要时生效
- [ ] 性能满足要求

---

## 相关文件

- `electron/main.ts` - 主进程虚拟键盘实现
- `electron/preload.ts` - IPC 桥接
- `src/pages/AIChat/index.tsx` - AI 聊天页面集成
- `src/components/SearchBox/SearchBox.tsx` - 搜索框集成（参考实现）

---

## 参考文档

- [Windows TabTip.exe 文档](https://docs.microsoft.com/en-us/windows/win32/tablet/text-input-panel)
- [Electron IPC 通信](https://www.electronjs.org/docs/latest/tutorial/ipc)
- [触摸屏优化最佳实践](https://docs.microsoft.com/en-us/windows/apps/design/input/touch-interactions)

---

**总结**: 虚拟键盘集成已优化完成，包含路径检测、防抖、重试、详细日志等机制。建议在真实 Windows 10 触摸屏设备上进行最终测试和调优。
