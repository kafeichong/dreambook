# DreamBook 闪屏问题修复指南

## 问题描述

运行 `cleanup-kiosk.bat` 清理脚本后，Windows 启动时出现闪屏（黑屏一闪而过），无法进入系统桌面。

## 问题原因

1. **setup-kiosk.bat 做了什么：**
   - 将 Windows Shell 替换为 DreamBook 应用 (`dreambook.exe`)
   - 这意味着登录后不再启动 explorer.exe（桌面），而是直接启动 DreamBook

2. **cleanup-kiosk.bat 的不完整清理：**
   - cleanup 脚本只清理了 Default User 的 Shell 配置
   - 但没有清理**当前登录用户**的 Shell 配置
   - 导致系统启动时仍然尝试运行 DreamBook 作为 Shell
   - 如果路径错误或配置不完整，就会闪屏后无响应

3. **Shell 配置位置：**
   ```
   HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell    ← 当前用户（cleanup 脚本遗漏了这个）
   HKU\DEF\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell  ← Default User（cleanup 脚本已清理）
   HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell     ← 系统默认（通常是 explorer.exe）
   ```

## 解决方案

### 方法 1：使用修复脚本（推荐）

1. **双击运行：**
   ```
   scripts/run-fix-as-admin.bat
   ```

2. **在 UAC 对话框中点击"是"** 授予管理员权限

3. **等待脚本执行完成**，会显示：
   ```
   ========================================
     修复完成！
   ========================================
   ```

4. **重启电脑**让配置生效

5. **正常登录 Windows**，不会再闪屏

### 方法 2：手动修复（高级用户）

如果修复脚本无法运行，可以手动清理注册表：

1. **按 Ctrl+Alt+Del** 打开任务管理器

2. **文件 > 运行新任务**，输入 `regedit`，勾选"以管理员身份运行"

3. **删除以下注册表项（如果存在）：**
   ```
   HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell
   ```

4. **关闭注册表编辑器，重启电脑**

### 方法 3：安全模式修复

如果无法进入系统：

1. **强制关机 3 次** 进入 Windows 恢复环境（WinRE）

2. **疑难解答 > 高级选项 > 启动设置 > 重启**

3. **按 F4 进入安全模式**

4. **在安全模式下运行修复脚本** 或手动清理注册表

## 修复脚本详情

### 修复脚本会做什么：

1. 清理**当前用户**的 Shell 配置（cleanup-kiosk.bat 遗漏的部分）
2. 清理 **Default User** 的 Shell 配置
3. 清理 **kiosk 用户**的 Shell 配置（如果存在）
4. 验证系统 Shell 是否恢复正常

### 日志文件：

修复过程的详细日志保存在：
```
scripts/fix-shell-config.log
```

## 预防措施

以后如果要清理 Kiosk 配置，请使用**改进的清理脚本**，而不是原来的 cleanup-kiosk.bat。

### 改进版清理脚本的特点：

- 清理所有用户的 Shell 配置（不仅是 Default User）
- 更安全的错误处理
- 详细的日志记录
- 清理前提示用户确认

## 技术说明

### Windows Shell 机制：

- **Shell** 是用户登录后启动的程序（通常是 explorer.exe）
- 如果将 Shell 替换为其他程序（如 DreamBook），登录后就只运行该程序
- 这是 Kiosk 模式的核心原理

### Kiosk 模式 vs 正常模式：

| 模式 | Shell | 特点 |
|------|-------|------|
| **正常模式** | explorer.exe | 有桌面、任务栏、开始菜单 |
| **Kiosk 模式** | dreambook.exe | 只运行 DreamBook，无桌面 |

### 清理不完整的后果：

- 如果只清理 Default User，但当前用户还有 Shell 替换配置
- 系统会尝试运行 DreamBook 作为 Shell
- 如果 DreamBook 不存在或启动失败 → 闪屏无响应

## 常见问题

### Q: 运行修复脚本后仍然闪屏？

A: 可能需要以下额外步骤：

1. **检查是否有多个用户账户**，每个账户都需要清理
2. **检查组策略设置**：
   ```
   gpedit.msc > 计算机配置 > 管理模板 > 系统 > 自定义用户界面
   ```
3. **检查启动项**：
   ```
   msconfig > 启动
   ```

### Q: 如何避免以后再出现这个问题？

A:
- 使用改进版清理脚本（本次已提供）
- 清理前做好系统备份
- 测试时使用虚拟机或专用测试设备

### Q: 如何正常使用 DreamBook 应用？

A: 修复后，DreamBook 恢复为普通应用模式：

1. 正常登录 Windows（看到桌面）
2. 双击 DreamBook 图标启动应用
3. 不再是 Kiosk 模式（可以切换到其他程序）

如果需要重新配置 Kiosk 模式，请：
1. 确保应用路径正确
2. 重新运行 setup-kiosk.bat
3. 使用改进版清理脚本备用

## 联系支持

如果以上方法都无法解决问题，请联系技术支持并提供：
- 错误截图
- 修复脚本的日志文件 (fix-shell-config.log)
- Windows 版本信息 (`winver` 命令）
